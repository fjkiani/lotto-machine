# Instructions

During you interaction with the user, if you find anything reusable in this project (e.g. version of a library, model name), especially about a fix to a mistake you made or a correction you received, you should take note in the `Lessons` section in the `.cursorrules` file so you will not make the same mistake again. 

You should also use the `.cursorrules` file as a scratchpad to organize your thoughts. Especially when you receive a new task, you should first review the content of the scratchpad, clear old different task if necessary, first explain the task, and plan the steps you need to take to complete the task. You can use todo markers to indicate the progress, e.g.
[X] Task 1
[ ] Task 2

Also update the progress of the task in the Scratchpad when you finish a subtask.
Especially when you finished a milestone, it will help to improve your depth of task accomplishment to use the scratchpad to reflect and plan.
The goal is to help you maintain a big picture as well as the progress of the task. Always refer to the Scratchpad when you plan the next step.

# Tools

Note all the tools are in python. So in the case you need to do batch processing, you can always consult the python files and write your own script.

## Screenshot Verification
The screenshot verification workflow allows you to capture screenshots of web pages and verify their appearance using LLMs. The following tools are available:

1. Screenshot Capture:
```bash
venv/bin/python tools/screenshot_utils.py URL [--output OUTPUT] [--width WIDTH] [--height HEIGHT]
```

2. LLM Verification with Images:
```bash
venv/bin/python tools/llm_api.py --prompt "Your verification question" --provider {openai|anthropic} --image path/to/screenshot.png
```

Example workflow:
```python
from screenshot_utils import take_screenshot_sync
from llm_api import query_llm

# Take a screenshot
screenshot_path = take_screenshot_sync('https://example.com', 'screenshot.png')

# Verify with LLM
response = query_llm(
    "What is the background color and title of this webpage?",
    provider="openai",  # or "anthropic"
    image_path=screenshot_path
)
print(response)
```

## LLM

You always have an LLM at your side to help you with the task. For simple tasks, you could invoke the LLM by running the following command:
```
venv/bin/python ./tools/llm_api.py --prompt "What is the capital of France?" --provider "anthropic"
```

The LLM API supports multiple providers:
- OpenAI (default, model: gpt-4o)
- Azure OpenAI (model: configured via AZURE_OPENAI_MODEL_DEPLOYMENT in .env file, defaults to gpt-4o-ms)
- DeepSeek (model: deepseek-chat)
- Anthropic (model: claude-3-sonnet-20240229)
- Gemini (model: gemini-pro)
- Local LLM (model: Qwen/Qwen2.5-32B-Instruct-AWQ)

But usually it's a better idea to check the content of the file and use the APIs in the `tools/llm_api.py` file to invoke the LLM if needed.

## Web browser

You could use the `tools/web_scraper.py` file to scrape the web.
```
venv/bin/python ./tools/web_scraper.py --max-concurrent 3 URL1 URL2 URL3
```
This will output the content of the web pages.

## Search engine

You could use the `tools/search_engine.py` file to search the web.
```
venv/bin/python ./tools/search_engine.py "your search keywords"
```
This will output the search results in the following format:
```
URL: https://example.com
Title: This is the title of the search result
Snippet: This is a snippet of the search result
```
If needed, you can further use the `web_scraper.py` file to scrape the web page content.

# Lessons

## User Specified Lessons

- You have a python venv in ./venv. Use it.
- Include info useful for debugging in the program output.
- Read the file before you try to edit it.
- Due to Cursor's limit, when you use `git` and `gh` and need to submit a multiline commit message, first write the message in a file, and then use `git commit -F <filename>` or similar command to commit. And then remove the file. Include "[Cursor] " in the commit message and PR title.

## Cursor learned

- For search results, ensure proper handling of different character encodings (UTF-8) for international queries
- Add debug information to stderr while keeping the main output clean in stdout for better pipeline integration
- When using seaborn styles in matplotlib, use 'seaborn-v0_8' instead of 'seaborn' as the style name due to recent seaborn version changes
- Use 'gpt-4o' as the model name for OpenAI's GPT-4 with vision capabilities
- When using f-strings with JSON templates, double the curly braces `{{` and `}}` to escape them properly and avoid format specifier errors
- When working with experimental models like `gemini-2.0-flash-thinking-exp-01-21`, always implement fallback mechanisms to standard models in case the experimental model is unavailable
- For options data, use RapidAPI directly instead of the YahooFinanceConnector class to avoid compatibility issues with the OptionChainQuote initialization
- When processing options data from RapidAPI, create a mapping of strikes to straddles for easier lookup and processing of call and put data
- When implementing the `display_analysis` function in Streamlit, ensure it combines all necessary display components (market overview, ticker analysis, technical insights, learning points) to avoid NameError exceptions
- When using RapidAPI endpoints, ensure to test endpoints first as the actual path may differ from documentation
- For news APIs, carefully examine the actual response structure as field names can vary across different providers
- When implementing general news functionality, some APIs require a symbol parameter even for general news, so use a broad market index (e.g., SPY) as a default
- Format date strings correctly from API responses by checking the actual format (e.g., space-separated vs T-separated datetime)
- When integrating Yahoo Finance Insights API, the response structure includes nested objects (e.g., `technicalEvents.shortTerm.action`) requiring careful extraction of values
- For technical indicators, use Streamlit's `st.metric` component to display values with optional delta values to enhance visualization
- When handling financial API data, ensure proper type conversion when using values from APIs for calculations (e.g., casting string values to float)
- In Streamlit visualizations with Plotly, set appropriate axis properties (`showticklabels`, `showgrid`, `zeroline`) to create cleaner charts
- When displaying technical levels (support, resistance), use different line styles (solid, dash, dot) and colors to differentiate between levels
- When integrating new features into an existing Streamlit app, ensure all data is properly passed through the session state management system
- For LLM prompt engineering, structure technical analysis prompts to include specific timeframes and technical indicators to get more detailed responses
- When working with Next.js, import Plotly.js dynamically with the `dynamic` import to avoid SSR issues, as it relies on browser APIs
- In Next.js API routes, always validate input parameters and send appropriate error responses with status codes
- For TypeScript integration with third-party libraries that don't have TypeScript declarations, create custom declaration files (.d.ts) in the types directory
- When migrating REST API connectors from Python to TypeScript, ensure careful transformation of deeply nested response objects, with proper null/undefined checks
- When designing scalable applications, use constant arrays or configuration objects for options that may need to be expanded in the future (like analysis types, providers, and time periods)
- When accessing nested properties in API responses, ensure property names match exactly with the TypeScript interface definitions and use optional chaining for potentially undefined values
- For LLM-based applications, add detailed error handling with fallback values for all possible response fields to ensure graceful degradation
- When working with LLM APIs, implement unified interfaces to support multiple providers (OpenAI, Gemini, Anthropic) with standardized request/response formats for easier switching between models
- For specialized financial analysis, use domain-specific prompts with detailed system instructions tailored to each analysis type
- Implement structured multi-agent architecture for complex analysis tasks, with separate specialized LLM agents for different domains (technical analysis, options analysis, etc.)
- When orchestrating multiple LLM agents, implement weighted confidence scoring to resolve contradictions and generate unified analysis
- For JSON response extraction from LLMs, include fallback parsing logic to handle cases where the JSON is embedded within text
- When implementing options analysis, ensure proper data preparation before sending to the LLM by transforming the options chain data into a format the LLM can effectively analyze
- For options data visualization, support both calls and puts in a tabbed interface that allows users to easily toggle between different views
- Add multiple risk tolerance levels (low, medium, high) when providing options strategy recommendations to cater to different investor profiles
- When handling options API responses, add fallback mechanisms for various response formats since LLMs can sometimes vary their output structure
- For complex financial UIs with multiple data components, use a card-based layout with clear sections for different types of analysis (market conditions, strategies, reasoning)
- When working with RapidAPI Yahoo Finance endpoints, always include the `/api` prefix in the path (e.g., `/api/stock/get-options` instead of `/stock/get-options`) as verified from working Streamlit implementation
- Be cautious of stray console.log statements, especially at the end of files, as they can cause ReferenceError if they reference variables out of scope
- In TypeScript, add explicit interface definitions for complex objects when using forEach/map/find to avoid 'implicitly has an any type' errors
- Always test API endpoints directly using curl or similar tools to verify the correct URL structure when experiencing 404 errors

# Scratchpad

## Options Analysis Feature Debugging and Enhancement

### Task Overview
We needed to debug and fix the Options Analysis feature in the Next.js application which was failing to fetch options chain data from the RapidAPI Yahoo Finance endpoint.

### Issues Identified and Fixed
1. **Incorrect API Endpoint Path**
   - Problem: The endpoint path `/stock/get-options` was incorrect
   - Fix: Updated to `/api/stock/get-options` based on Python implementation and successful API test
   - Status: ✅ Fixed

2. **Stray Console.log Statement**
   - Problem: A reference error was occurring due to a stray console.log at the end of api.ts
   - Fix: Removed the problematic statement
   - Status: ✅ Fixed

3. **TypeScript Type Errors**
   - Problem: Several 'implicitly has an any type' errors in options-chain.ts
   - Fix: Added proper TypeScript interfaces for OptionDate and OptionStraddleData
   - Status: ✅ Fixed

### Current Status
The core options analysis feature is now working properly. We've fixed:

1. **API Integration:**
   - ✅ Corrected RapidAPI endpoint path
   - ✅ Fixed the error in the API utility file
   - ✅ Added proper TypeScript typings

2. **Data Structure:**
   - ✅ Options chain data is now correctly fetched and transformed
   - ✅ The API returns proper JSON data with complete options chain information
   - ✅ Type definitions match the actual data structure

### Next Steps
1. **Comprehensive Testing**
   - [ ] Test with various tickers (AAPL, MSFT, GOOGL, AMZN, TSLA)
   - [ ] Test with different expiration dates (nearest, monthly, quarterly)
   - [ ] Validate LLM analysis with different risk tolerance settings

2. **UI Enhancements**
   - [ ] Improve error handling with user-friendly messages
   - [ ] Add loading spinners or skeleton loaders during data fetch
   - [ ] Optimize mobile view for better small screen experience

3. **Performance Optimizations**
   - [ ] Implement caching for options data to reduce API calls
   - [ ] Add pagination or virtual scrolling for large options chains
   - [ ] Optimize rendering of the options chain table

4. **Feature Additions**
   - [ ] Add option to download options data as CSV
   - [ ] Add visualization of implied volatility smile
   - [ ] Enhance LLM prompt for more detailed strategy explanations
   - [ ] Implement multi-expiration comparison view

### Development Priorities (in order)
1. Complete testing with different tickers and expiration dates
2. Enhance error handling and loading states
3. Implement caching to improve performance
4. Add basic data visualizations (IV curve, etc.)
5. Improve mobile responsiveness