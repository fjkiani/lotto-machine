#!/usr/bin/env python3
"""
üî• GET EXPLOITATION DATA - SIMPLE DATA FETCHER

Uses existing UltimateChartExchangeClient to fetch all data we need
for exploitation phases. NO TESTS - JUST GET THE DATA.
"""

import os
import sys
import json
from datetime import datetime
from typing import Dict, List, Optional

# Add project root to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../..'))

from core.data.ultimate_chartexchange_client import UltimateChartExchangeClient


class ExploitationDataFetcher:
    """Simple data fetcher for exploitation phases."""
    
    def __init__(self, api_key: str):
        self.client = UltimateChartExchangeClient(api_key, tier=3)
        self.results = {}
        
    def fetch_phase1_data(self, symbol: str = "SPY") -> Dict:
        """Fetch Phase 1: Short Squeeze Detection data."""
        print(f"\nüî• PHASE 1: Fetching Short Squeeze Data for {symbol}")
        print("=" * 80)
        
        data = {}
        
        # Short Interest
        print("\nüìä Short Interest...")
        si_data = self.client.get_short_interest(symbol)
        if si_data:
            print(f"   ‚úÖ Got data: {type(si_data)}")
            if isinstance(si_data, list) and len(si_data) > 0:
                print(f"   Sample: {si_data[0]}")
            elif isinstance(si_data, dict):
                print(f"   Keys: {list(si_data.keys())}")
            data['short_interest'] = si_data
        else:
            print("   ‚ùå No data")
            data['short_interest'] = None
        
        # Short Interest Daily
        print("\nüìä Short Interest Daily...")
        si_daily = self.client.get_short_interest_daily(symbol)
        if si_daily:
            print(f"   ‚úÖ Got {len(si_daily)} records")
            if len(si_daily) > 0:
                print(f"   Sample: {si_daily[0]}")
            data['short_interest_daily'] = si_daily
        else:
            print("   ‚ùå No data")
            data['short_interest_daily'] = []
        
        # Borrow Fee
        print("\nüìä Borrow Fee (IB)...")
        try:
            bf_data = self.client.get_borrow_fee(symbol)
            if bf_data:
                print(f"   ‚úÖ Got data")
                print(f"   Fee Rate: {bf_data.fee_rate:.2f}%")
                print(f"   Available Shares: {bf_data.available_shares:,}")
                data['borrow_fee'] = {
                    'fee_rate': bf_data.fee_rate,
                    'available_shares': bf_data.available_shares,
                    'date': bf_data.date
                }
            else:
                print("   ‚ùå No data")
                data['borrow_fee'] = None
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            import traceback
            traceback.print_exc()
            data['borrow_fee'] = None
        
        # FTD Data
        print("\nüìä Failure to Deliver...")
        try:
            ftd_data = self.client.get_failure_to_deliver(symbol)
            if ftd_data:
                print(f"   ‚úÖ Got {len(ftd_data)} records")
                if len(ftd_data) > 0:
                    print(f"   Sample: {ftd_data[0].date} - {ftd_data[0].quantity:,} shares @ ${ftd_data[0].price:.2f}")
                data['ftd'] = [
                    {
                        'date': ftd.date,
                        'quantity': ftd.quantity,
                        'price': ftd.price
                    }
                    for ftd in ftd_data
                ]
            else:
                print("   ‚ùå No data")
                data['ftd'] = []
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            import traceback
            traceback.print_exc()
            data['ftd'] = None
        
        self.results['phase1'] = data
        return data
    
    def fetch_phase2_data(self, symbol: str = "SPY") -> Dict:
        """Fetch Phase 2: Options Flow Intelligence data."""
        print(f"\nüî• PHASE 2: Fetching Options Flow Data for {symbol}")
        print("=" * 80)
        
        data = {}
        
        # Options Chain Summary
        print("\nüìä Options Chain Summary...")
        ocs = self.client.get_options_chain_summary(symbol)
        if ocs:
            print(f"   ‚úÖ Got data")
            print(f"   Max Pain: ${ocs.max_pain:.2f}")
            print(f"   P/C Ratio: {ocs.put_call_ratio:.2f}")
            print(f"   Call OI: {ocs.total_call_oi:,}")
            print(f"   Put OI: {ocs.total_put_oi:,}")
            data['chain_summary'] = {
                'max_pain': ocs.max_pain,
                'put_call_ratio': ocs.put_call_ratio,
                'total_call_oi': ocs.total_call_oi,
                'total_put_oi': ocs.total_put_oi,
                'itm_calls': ocs.itm_calls,
                'otm_calls': ocs.otm_calls,
            }
        else:
            print("   ‚ùå No data")
            data['chain_summary'] = None
        
        self.results['phase2'] = data
        return data
    
    def fetch_phase3_data(self) -> Dict:
        """Fetch Phase 3: Opportunity Scanner data."""
        print(f"\nüî• PHASE 3: Fetching Screener Data")
        print("=" * 80)
        
        data = {}
        
        # Stock Screener
        print("\nüìä Stock Screener (High Short Interest)...")
        try:
            # Use screen_stocks with filter dict
            screener_results = self.client.screen_stocks({
                'short_interest__gte': 15,
                'avg_volume__gte': 1000000,
                'price__gte': 10,
                'page_size': 10
            })
            if screener_results:
                print(f"   ‚úÖ Got {len(screener_results)} results")
                if len(screener_results) > 0:
                    print(f"   Top 3: {[r.get('symbol', r.get('display', 'N/A')) for r in screener_results[:3]]}")
                data['screener'] = screener_results
            else:
                print("   ‚ùå No data")
                data['screener'] = []
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            import traceback
            traceback.print_exc()
            data['screener'] = None
        
        self.results['phase3'] = data
        return data
    
    def fetch_phase5_data(self, symbol: str = "SPY") -> Dict:
        """Fetch Phase 5: Reddit Sentiment data."""
        print(f"\nüî• PHASE 5: Fetching Reddit Sentiment Data for {symbol}")
        print("=" * 80)
        
        data = {}
        
        # Reddit Daily Mentions
        print("\nüìä Reddit Daily Mentions...")
        try:
            reddit_data = self.client.get_reddit_daily_mentions(symbol, days=7)
            if reddit_data:
                print(f"   ‚úÖ Got {len(reddit_data)} records")
                if len(reddit_data) > 0:
                    print(f"   Sample: {reddit_data[0]}")
                data['reddit_daily'] = reddit_data
            else:
                print("   ‚ùå No data")
                data['reddit_daily'] = []
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            import traceback
            traceback.print_exc()
            data['reddit_daily'] = None
        
        # Reddit Mentions (general)
        print("\nüìä Reddit Mentions (General)...")
        try:
            reddit_mentions = self.client.get_reddit_mentions(symbol, days=7)
            if reddit_mentions:
                if isinstance(reddit_mentions, list):
                    print(f"   ‚úÖ Got {len(reddit_mentions)} records")
                    if len(reddit_mentions) > 0:
                        print(f"   Sample: {reddit_mentions[0]}")
                elif isinstance(reddit_mentions, dict):
                    print(f"   ‚úÖ Got dict response")
                    print(f"   Keys: {list(reddit_mentions.keys())}")
                data['reddit_mentions'] = reddit_mentions
            else:
                print("   ‚ùå No data")
                data['reddit_mentions'] = []
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
            import traceback
            traceback.print_exc()
            data['reddit_mentions'] = None
        
        self.results['phase5'] = data
        return data
    
    def fetch_all(self, symbol: str = "SPY") -> Dict:
        """Fetch all exploitation data."""
        print("=" * 80)
        print("üî• FETCHING ALL EXPLOITATION DATA")
        print("=" * 80)
        print(f"\nSymbol: {symbol}")
        print(f"Timestamp: {datetime.now().isoformat()}\n")
        
        all_data = {
            'phase1': self.fetch_phase1_data(symbol),
            'phase2': self.fetch_phase2_data(symbol),
            'phase3': self.fetch_phase3_data(),
            'phase5': self.fetch_phase5_data(symbol),
        }
        
        # Summary
        print("\n" + "=" * 80)
        print("üìä FETCH SUMMARY")
        print("=" * 80)
        
        for phase, phase_data in all_data.items():
            print(f"\n{phase.upper()}:")
            for key, value in phase_data.items():
                if value is None:
                    status = "‚ùå MISSING"
                elif isinstance(value, list):
                    status = f"‚úÖ {len(value)} records"
                elif isinstance(value, dict):
                    status = "‚úÖ Got data"
                else:
                    status = "‚úÖ Got data"
                print(f"   {key}: {status}")
        
        return all_data


def main():
    """Main function."""
    api_key = os.getenv('CHARTEXCHANGE_API_KEY')
    
    if not api_key:
        print("‚ùå ERROR: CHARTEXCHANGE_API_KEY not set!")
        print("Set it with: export CHARTEXCHANGE_API_KEY='your_key'")
        sys.exit(1)
    
    fetcher = ExploitationDataFetcher(api_key)
    all_data = fetcher.fetch_all("SPY")
    
    # Save to JSON
    output_file = "exploitation_data.json"
    with open(output_file, 'w') as f:
        json.dump(all_data, f, indent=2, default=str)
    print(f"\nüìÅ Data saved to: {output_file}")
    
    # Check what's missing
    missing = []
    for phase, phase_data in all_data.items():
        for key, value in phase_data.items():
            if value is None:
                missing.append(f"{phase}.{key}")
    
    if missing:
        print(f"\n‚ö†Ô∏è  MISSING DATA: {len(missing)} endpoints")
        print("   Need to add methods to UltimateChartExchangeClient:")
        for m in missing:
            print(f"   - {m}")
    else:
        print("\n‚úÖ ALL DATA FETCHED SUCCESSFULLY!")


if __name__ == "__main__":
    main()

