#!/usr/bin/env python3
"""
ğŸ” DATA STRUCTURE VALIDATION TESTS

Validates that API responses have the fields we need for each exploitation phase.
"""

import os
import sys
import json
from typing import Dict, List, Optional, Any

sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../..'))

from tests.exploitation.test_api_data_availability import (
    Phase1APITester, Phase2APITester, Phase3APITester, Phase5APITester
)


class DataStructureValidator:
    """Validates API response structures."""
    
    def validate_short_interest(self, data: Any) -> Dict[str, bool]:
        """Validate short interest data structure."""
        required_fields = ['short_interest', 'date']
        optional_fields = ['short_interest_ratio', 'float']
        
        if isinstance(data, list):
            if len(data) == 0:
                return {'has_data': False, 'valid': False}
            data = data[0]
        
        if not isinstance(data, dict):
            return {'has_data': False, 'valid': False}
        
        results = {'has_data': True}
        
        for field in required_fields:
            results[f'has_{field}'] = field in data
            results['valid'] = results.get('valid', True) and field in data
        
        for field in optional_fields:
            results[f'has_{field}'] = field in data
        
        return results
    
    def validate_borrow_fee(self, data: Any) -> Dict[str, bool]:
        """Validate borrow fee data structure."""
        required_fields = ['borrow_fee', 'date']
        optional_fields = ['available_shares', 'symbol']
        
        if isinstance(data, list):
            if len(data) == 0:
                return {'has_data': False, 'valid': False}
            data = data[0]
        
        if not isinstance(data, dict):
            return {'has_data': False, 'valid': False}
        
        results = {'has_data': True}
        
        for field in required_fields:
            results[f'has_{field}'] = field in data
            results['valid'] = results.get('valid', True) and field in data
        
        for field in optional_fields:
            results[f'has_{field}'] = field in data
        
        return results
    
    def validate_ftd_data(self, data: Any) -> Dict[str, bool]:
        """Validate FTD data structure."""
        required_fields = ['quantity', 'date']
        optional_fields = ['symbol', 'settlement_date']
        
        if not isinstance(data, list):
            return {'has_data': False, 'valid': False}
        
        if len(data) == 0:
            return {'has_data': False, 'valid': False}
        
        # Check first record
        record = data[0]
        if not isinstance(record, dict):
            return {'has_data': False, 'valid': False}
        
        results = {'has_data': True, 'record_count': len(data)}
        
        for field in required_fields:
            results[f'has_{field}'] = field in record
            results['valid'] = results.get('valid', True) and field in record
        
        for field in optional_fields:
            results[f'has_{field}'] = field in record
        
        return results
    
    def validate_options_chain_summary(self, data: Any) -> Dict[str, bool]:
        """Validate options chain summary structure."""
        required_fields = ['max_pain']
        optional_fields = ['total_call_oi', 'total_put_oi', 'itm_call_oi', 'otm_call_oi', 'expiration']
        
        if isinstance(data, list):
            if len(data) == 0:
                return {'has_data': False, 'valid': False}
            data = data[0]
        
        if not isinstance(data, dict):
            return {'has_data': False, 'valid': False}
        
        results = {'has_data': True}
        
        for field in required_fields:
            results[f'has_{field}'] = field in data
            results['valid'] = results.get('valid', True) and field in data
        
        for field in optional_fields:
            results[f'has_{field}'] = field in data
        
        return results
    
    def validate_screener_results(self, data: Any) -> Dict[str, bool]:
        """Validate screener results structure."""
        if not isinstance(data, list):
            return {'has_data': False, 'valid': False}
        
        if len(data) == 0:
            return {'has_data': False, 'valid': False}
        
        # Check first result
        result = data[0]
        if not isinstance(result, dict):
            return {'has_data': False, 'valid': False}
        
        # Screener should have symbol at minimum
        required_fields = ['symbol']
        optional_fields = ['short_interest', 'avg_volume', 'price', 'volume_ratio', 'days_to_earnings']
        
        validation_results = {'has_data': True, 'result_count': len(data)}
        
        for field in required_fields:
            validation_results[f'has_{field}'] = field in result
            validation_results['valid'] = validation_results.get('valid', True) and field in result
        
        for field in optional_fields:
            validation_results[f'has_{field}'] = field in result
        
        return validation_results
    
    def validate_reddit_daily_mentions(self, data: Any) -> Dict[str, bool]:
        """Validate Reddit daily mentions structure."""
        if not isinstance(data, list):
            return {'has_data': False, 'valid': False}
        
        if len(data) == 0:
            return {'has_data': False, 'valid': False}
        
        record = data[0]
        if not isinstance(record, dict):
            return {'has_data': False, 'valid': False}
        
        required_fields = ['date']
        optional_fields = ['mentions', 'sentiment', 'symbol']
        
        results = {'has_data': True, 'record_count': len(data)}
        
        for field in required_fields:
            results[f'has_{field}'] = field in record
            results['valid'] = results.get('valid', True) and field in record
        
        for field in optional_fields:
            results[f'has_{field}'] = field in record
        
        return results


def validate_phase1_data(api_key: str) -> Dict:
    """Validate Phase 1 data structures."""
    print("\n" + "=" * 80)
    print("ğŸ” PHASE 1 DATA STRUCTURE VALIDATION")
    print("=" * 80)
    
    tester = Phase1APITester(api_key)
    validator = DataStructureValidator()
    
    results = {}
    
    # Test short interest
    print("\nğŸ“Š Validating Short Interest...")
    si_data = tester._make_request("/data/stocks/short-interest/", {"symbol": "US:SPY"})
    if si_data:
        results['short_interest'] = validator.validate_short_interest(si_data)
        print(f"   âœ… Structure valid: {results['short_interest']['valid']}")
        print(f"   Fields: {list(si_data[0].keys()) if isinstance(si_data, list) and len(si_data) > 0 else list(si_data.keys())}")
    else:
        results['short_interest'] = {'has_data': False, 'valid': False}
        print("   âŒ No data to validate")
    
    # Test borrow fee
    print("\nğŸ“Š Validating Borrow Fee...")
    bf_data = tester._make_request("/data/stocks/borrow-fee/ib/", {"symbol": "US:SPY"})
    if bf_data:
        results['borrow_fee'] = validator.validate_borrow_fee(bf_data)
        print(f"   âœ… Structure valid: {results['borrow_fee']['valid']}")
        print(f"   Fields: {list(bf_data[0].keys()) if isinstance(bf_data, list) and len(bf_data) > 0 else list(bf_data.keys())}")
    else:
        results['borrow_fee'] = {'has_data': False, 'valid': False}
        print("   âŒ No data to validate")
    
    # Test FTD
    print("\nğŸ“Š Validating FTD Data...")
    ftd_data = tester._make_request("/data/stocks/failure-to-deliver/", {"symbol": "US:SPY"})
    if ftd_data:
        results['ftd'] = validator.validate_ftd_data(ftd_data)
        print(f"   âœ… Structure valid: {results['ftd']['valid']}")
        if isinstance(ftd_data, list) and len(ftd_data) > 0:
            print(f"   Fields: {list(ftd_data[0].keys())}")
            print(f"   Records: {len(ftd_data)}")
    else:
        results['ftd'] = {'has_data': False, 'valid': False}
        print("   âŒ No data to validate")
    
    return results


def validate_phase2_data(api_key: str) -> Dict:
    """Validate Phase 2 data structures."""
    print("\n" + "=" * 80)
    print("ğŸ” PHASE 2 DATA STRUCTURE VALIDATION")
    print("=" * 80)
    
    tester = Phase2APITester(api_key)
    validator = DataStructureValidator()
    
    results = {}
    
    # Test options chain summary
    print("\nğŸ“Š Validating Options Chain Summary...")
    ocs_data = tester._make_request("/data/options/chain-summary/", {"symbol": "US:SPY"})
    if ocs_data:
        results['chain_summary'] = validator.validate_options_chain_summary(ocs_data)
        print(f"   âœ… Structure valid: {results['chain_summary']['valid']}")
        print(f"   Fields: {list(ocs_data[0].keys()) if isinstance(ocs_data, list) and len(ocs_data) > 0 else list(ocs_data.keys())}")
    else:
        results['chain_summary'] = {'has_data': False, 'valid': False}
        print("   âŒ No data to validate")
    
    return results


def validate_phase3_data(api_key: str) -> Dict:
    """Validate Phase 3 data structures."""
    print("\n" + "=" * 80)
    print("ğŸ” PHASE 3 DATA STRUCTURE VALIDATION")
    print("=" * 80)
    
    tester = Phase3APITester(api_key)
    validator = DataStructureValidator()
    
    results = {}
    
    # Test screener
    print("\nğŸ“Š Validating Stock Screener...")
    screener_data = tester._make_request("/screener/stocks/", {
        "short_interest__gte": 15,
        "page_size": 5
    })
    if screener_data:
        results['screener'] = validator.validate_screener_results(screener_data)
        print(f"   âœ… Structure valid: {results['screener']['valid']}")
        if isinstance(screener_data, list) and len(screener_data) > 0:
            print(f"   Fields: {list(screener_data[0].keys())}")
            print(f"   Results: {len(screener_data)}")
    else:
        results['screener'] = {'has_data': False, 'valid': False}
        print("   âŒ No data to validate")
    
    return results


def validate_phase5_data(api_key: str) -> Dict:
    """Validate Phase 5 data structures."""
    print("\n" + "=" * 80)
    print("ğŸ” PHASE 5 DATA STRUCTURE VALIDATION")
    print("=" * 80)
    
    tester = Phase5APITester(api_key)
    validator = DataStructureValidator()
    
    results = {}
    
    # Test Reddit daily mentions
    print("\nğŸ“Š Validating Reddit Daily Mentions...")
    reddit_data = tester._make_request("/data/reddit/mentions/daily/stock/SPY/", {"days": 7})
    if reddit_data:
        results['reddit_daily'] = validator.validate_reddit_daily_mentions(reddit_data)
        print(f"   âœ… Structure valid: {results['reddit_daily']['valid']}")
        if isinstance(reddit_data, list) and len(reddit_data) > 0:
            print(f"   Fields: {list(reddit_data[0].keys())}")
            print(f"   Records: {len(reddit_data)}")
    else:
        results['reddit_daily'] = {'has_data': False, 'valid': False}
        print("   âŒ No data to validate")
    
    return results


def main():
    """Run all data structure validations."""
    api_key = os.getenv('CHARTEXCHANGE_API_KEY')
    
    if not api_key:
        print("âŒ ERROR: CHARTEXCHANGE_API_KEY not set!")
        sys.exit(1)
    
    print("=" * 80)
    print("ğŸ” COMPREHENSIVE DATA STRUCTURE VALIDATION")
    print("=" * 80)
    
    all_results = {
        'phase1': validate_phase1_data(api_key),
        'phase2': validate_phase2_data(api_key),
        'phase3': validate_phase3_data(api_key),
        'phase5': validate_phase5_data(api_key),
    }
    
    # Summary
    print("\n" + "=" * 80)
    print("ğŸ“Š VALIDATION SUMMARY")
    print("=" * 80)
    
    for phase, results in all_results.items():
        print(f"\n{phase.upper()}:")
        for endpoint, validation in results.items():
            status = "âœ… VALID" if validation.get('valid', False) else "âŒ INVALID"
            has_data = "âœ…" if validation.get('has_data', False) else "âŒ"
            print(f"   {endpoint}: {status} (has_data: {has_data})")
    
    # Save results
    output_file = "data_structure_validation.json"
    with open(output_file, 'w') as f:
        json.dump(all_results, f, indent=2, default=str)
    print(f"\nğŸ“ Results saved to: {output_file}")


if __name__ == "__main__":
    main()


