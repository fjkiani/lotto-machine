#!/usr/bin/env python3
"""
ğŸ”¥ API DATA AVAILABILITY TESTS

Tests that we can actually GET the data we need from ChartExchange APIs
before building the exploitation modules.

NO MOCK DATA. Real API calls only.
"""

import os
import sys
import json
from datetime import datetime, timedelta
from typing import Optional, Dict, List
import requests

# Add project root to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../..'))

class APITester:
    """Base class for API testing."""
    
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://api.chartexchange.com"
        self.headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }
        self.results = {}
        
    def _make_request(self, endpoint: str, params: Dict = None) -> Optional[Dict]:
        """Make API request, return None on failure."""
        try:
            url = f"{self.base_url}{endpoint}"
            response = requests.get(url, headers=self.headers, params=params, timeout=10)
            
            if response.status_code == 200:
                return response.json()
            else:
                print(f"   âŒ API returned {response.status_code}: {response.text[:200]}")
                return None
        except Exception as e:
            print(f"   âŒ Request failed: {e}")
            return None
    
    def test_endpoint(self, name: str, endpoint: str, params: Dict = None) -> bool:
        """Test an endpoint and store results."""
        print(f"\nğŸ“¡ Testing {name}...")
        print(f"   Endpoint: {endpoint}")
        if params:
            print(f"   Params: {params}")
            
        data = self._make_request(endpoint, params)
        
        if data:
            print(f"   âœ… SUCCESS - Got data")
            print(f"   Response type: {type(data)}")
            
            if isinstance(data, list):
                print(f"   Records: {len(data)}")
                if len(data) > 0:
                    print(f"   Sample keys: {list(data[0].keys()) if isinstance(data[0], dict) else 'N/A'}")
            elif isinstance(data, dict):
                print(f"   Keys: {list(data.keys())}")
                
            self.results[name] = {
                'status': 'success',
                'data': data,
                'endpoint': endpoint,
                'params': params
            }
            return True
        else:
            print(f"   âŒ FAILED - No data returned")
            self.results[name] = {
                'status': 'failed',
                'endpoint': endpoint,
                'params': params
            }
            return False


class Phase1APITester(APITester):
    """Test Phase 1: Short Squeeze Detection APIs."""
    
    def test_short_interest(self, symbol: str = "US:SPY") -> bool:
        """Test /data/stocks/short-interest/ endpoint."""
        return self.test_endpoint(
            "Short Interest",
            "/data/stocks/short-interest/",
            {"symbol": symbol}
        )
    
    def test_short_interest_daily(self, symbol: str = "US:SPY") -> bool:
        """Test /data/stocks/short-interest-daily/ endpoint."""
        return self.test_endpoint(
            "Short Interest Daily",
            "/data/stocks/short-interest-daily/",
            {"symbol": symbol}
        )
    
    def test_borrow_fee(self, symbol: str = "US:SPY") -> bool:
        """Test /data/stocks/borrow-fee/ib/ endpoint."""
        return self.test_endpoint(
            "Borrow Fee (IB)",
            "/data/stocks/borrow-fee/ib/",
            {"symbol": symbol}
        )
    
    def test_ftd_data(self, symbol: str = "US:SPY") -> bool:
        """Test /data/stocks/failure-to-deliver/ endpoint."""
        return self.test_endpoint(
            "Failure to Deliver",
            "/data/stocks/failure-to-deliver/",
            {"symbol": symbol}
        )
    
    def run_all_tests(self, symbol: str = "US:SPY") -> Dict:
        """Run all Phase 1 API tests."""
        print("=" * 80)
        print("ğŸ”¥ PHASE 1: SHORT SQUEEZE DETECTION API TESTS")
        print("=" * 80)
        print(f"\nTesting symbol: {symbol}\n")
        
        tests = [
            ("Short Interest", self.test_short_interest, symbol),
            ("Short Interest Daily", self.test_short_interest_daily, symbol),
            ("Borrow Fee", self.test_borrow_fee, symbol),
            ("FTD Data", self.test_ftd_data, symbol),
        ]
        
        passed = 0
        failed = 0
        
        for name, test_func, arg in tests:
            if test_func(arg):
                passed += 1
            else:
                failed += 1
        
        print("\n" + "=" * 80)
        print(f"ğŸ“Š RESULTS: {passed} passed, {failed} failed")
        print("=" * 80)
        
        return {
            'passed': passed,
            'failed': failed,
            'results': self.results
        }


class Phase2APITester(APITester):
    """Test Phase 2: Options Flow Intelligence APIs."""
    
    def test_options_chain_summary(self, symbol: str = "US:SPY") -> bool:
        """Test /data/options/chain-summary/ endpoint."""
        return self.test_endpoint(
            "Options Chain Summary",
            "/data/options/chain-summary/",
            {"symbol": symbol}
        )
    
    def test_options_bars(self, symbol: str = "US:SPY") -> bool:
        """Test /data/options/bars/ endpoint."""
        # Try to get recent options bars
        today = datetime.now().strftime('%Y-%m-%d')
        return self.test_endpoint(
            "Options Bars",
            "/data/options/bars/",
            {
                "symbol": symbol,
                "start_date": (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d'),
                "end_date": today
            }
        )
    
    def run_all_tests(self, symbol: str = "US:SPY") -> Dict:
        """Run all Phase 2 API tests."""
        print("=" * 80)
        print("ğŸ”¥ PHASE 2: OPTIONS FLOW INTELLIGENCE API TESTS")
        print("=" * 80)
        print(f"\nTesting symbol: {symbol}\n")
        
        tests = [
            ("Options Chain Summary", self.test_options_chain_summary, symbol),
            ("Options Bars", self.test_options_bars, symbol),
        ]
        
        passed = 0
        failed = 0
        
        for name, test_func, arg in tests:
            if test_func(arg):
                passed += 1
            else:
                failed += 1
        
        print("\n" + "=" * 80)
        print(f"ğŸ“Š RESULTS: {passed} passed, {failed} failed")
        print("=" * 80)
        
        return {
            'passed': passed,
            'failed': failed,
            'results': self.results
        }


class Phase3APITester(APITester):
    """Test Phase 3: Multi-Ticker Opportunity Scanner APIs."""
    
    def test_stock_screener(self) -> bool:
        """Test /screener/stocks/ endpoint."""
        # Test basic screener query
        return self.test_endpoint(
            "Stock Screener",
            "/screener/stocks/",
            {
                "short_interest__gte": 15,
                "avg_volume__gte": 1000000,
                "price__gte": 10,
                "page_size": 10
            }
        )
    
    def test_screener_columns(self) -> bool:
        """Test /screener/stocks/columns/ endpoint."""
        return self.test_endpoint(
            "Screener Columns",
            "/screener/stocks/columns/"
        )
    
    def run_all_tests(self) -> Dict:
        """Run all Phase 3 API tests."""
        print("=" * 80)
        print("ğŸ”¥ PHASE 3: OPPORTUNITY SCANNER API TESTS")
        print("=" * 80)
        print()
        
        tests = [
            ("Stock Screener", self.test_stock_screener, None),
            ("Screener Columns", self.test_screener_columns, None),
        ]
        
        passed = 0
        failed = 0
        
        for name, test_func, arg in tests:
            if test_func() if arg is None else test_func(arg):
                passed += 1
            else:
                failed += 1
        
        print("\n" + "=" * 80)
        print(f"ğŸ“Š RESULTS: {passed} passed, {failed} failed")
        print("=" * 80)
        
        return {
            'passed': passed,
            'failed': failed,
            'results': self.results
        }


class Phase5APITester(APITester):
    """Test Phase 5: Enhanced Reddit Sentiment APIs."""
    
    def test_reddit_daily_mentions(self, symbol: str = "SPY") -> bool:
        """Test /data/reddit/mentions/daily/stock/ endpoint."""
        return self.test_endpoint(
            "Reddit Daily Mentions",
            f"/data/reddit/mentions/daily/stock/{symbol}/",
            {"days": 7}
        )
    
    def test_reddit_top_mentions(self) -> bool:
        """Test /data/reddit/mentions/top/ endpoint."""
        return self.test_endpoint(
            "Reddit Top Mentions",
            "/data/reddit/mentions/top/",
            {"days": 1}
        )
    
    def run_all_tests(self, symbol: str = "SPY") -> Dict:
        """Run all Phase 5 API tests."""
        print("=" * 80)
        print("ğŸ”¥ PHASE 5: REDDIT SENTIMENT API TESTS")
        print("=" * 80)
        print(f"\nTesting symbol: {symbol}\n")
        
        tests = [
            ("Reddit Daily Mentions", self.test_reddit_daily_mentions, symbol),
            ("Reddit Top Mentions", self.test_reddit_top_mentions, None),
        ]
        
        passed = 0
        failed = 0
        
        for name, test_func, arg in tests:
            if arg is None:
                if test_func():
                    passed += 1
                else:
                    failed += 1
            else:
                if test_func(arg):
                    passed += 1
                else:
                    failed += 1
        
        print("\n" + "=" * 80)
        print(f"ğŸ“Š RESULTS: {passed} passed, {failed} failed")
        print("=" * 80)
        
        return {
            'passed': passed,
            'failed': failed,
            'results': self.results
        }


def main():
    """Run all API availability tests."""
    api_key = os.getenv('CHARTEXCHANGE_API_KEY')
    
    if not api_key:
        print("âŒ ERROR: CHARTEXCHANGE_API_KEY not set!")
        print("Set it with: export CHARTEXCHANGE_API_KEY='your_key'")
        sys.exit(1)
    
    print("=" * 80)
    print("ğŸ”¥ COMPREHENSIVE API DATA AVAILABILITY TEST")
    print("=" * 80)
    print(f"\nAPI Key: {api_key[:10]}...{api_key[-5:]}")
    print(f"Timestamp: {datetime.now().isoformat()}\n")
    
    all_results = {}
    
    # Phase 1: Short Squeeze Detection
    phase1 = Phase1APITester(api_key)
    phase1_results = phase1.run_all_tests("US:SPY")
    all_results['phase1'] = phase1_results
    
    # Phase 2: Options Flow
    phase2 = Phase2APITester(api_key)
    phase2_results = phase2.run_all_tests("US:SPY")
    all_results['phase2'] = phase2_results
    
    # Phase 3: Opportunity Scanner
    phase3 = Phase3APITester(api_key)
    phase3_results = phase3.run_all_tests()
    all_results['phase3'] = phase3_results
    
    # Phase 5: Reddit Sentiment
    phase5 = Phase5APITester(api_key)
    phase5_results = phase5.run_all_tests("SPY")
    all_results['phase5'] = phase5_results
    
    # Summary
    print("\n" + "=" * 80)
    print("ğŸ“Š FINAL SUMMARY")
    print("=" * 80)
    
    total_passed = sum(r['passed'] for r in all_results.values())
    total_failed = sum(r['failed'] for r in all_results.values())
    
    print(f"\nPhase 1 (Short Squeeze): {phase1_results['passed']}/{phase1_results['passed'] + phase1_results['failed']} passed")
    print(f"Phase 2 (Options Flow): {phase2_results['passed']}/{phase2_results['passed'] + phase2_results['failed']} passed")
    print(f"Phase 3 (Scanner): {phase3_results['passed']}/{phase3_results['passed'] + phase3_results['failed']} passed")
    print(f"Phase 5 (Reddit): {phase5_results['passed']}/{phase5_results['passed'] + phase5_results['failed']} passed")
    
    print(f"\nğŸ¯ TOTAL: {total_passed} passed, {total_failed} failed")
    
    if total_failed == 0:
        print("\nâœ… ALL APIS WORKING - READY TO BUILD MODULES!")
    else:
        print(f"\nâš ï¸  {total_failed} API(s) FAILED - Review before building modules")
    
    # Save detailed results
    output_file = "api_test_results.json"
    with open(output_file, 'w') as f:
        json.dump(all_results, f, indent=2, default=str)
    print(f"\nğŸ“ Detailed results saved to: {output_file}")
    
    return total_failed == 0


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)


