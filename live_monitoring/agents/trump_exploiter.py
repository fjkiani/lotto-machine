#!/usr/bin/env python3
"""
TRUMP EXPLOITER - "HOW do we profit?"

This module answers: What trades should we make based on current Trump situation?
Returns: Actionable trading signals with entry, stop, target.

Usage:
    from trump_exploiter import TrumpExploiter
    exploiter = TrumpExploiter()
    trades = exploiter.get_exploit_signals()
"""

import os
import sys
import logging
from datetime import datetime, timedelta
from typing import List, Dict, Any, Optional
from dataclasses import dataclass, field

# Add paths
base_path = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
sys.path.insert(0, base_path)
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from trump_pulse import TrumpPulse, TrumpSituation
from trump_calendar import TrumpCalendar, TrumpCalendarReport
from trump_database import TrumpDatabase
from trump_playbook import TrumpPlaybookAnalyzer

logger = logging.getLogger(__name__)


@dataclass
class TrumpTrade:
    """A specific trading signal based on Trump intelligence."""
    signal_id: str
    action: str  # BUY, SELL, SHORT, COVER, FADE, AVOID
    symbol: str
    reason: str
    timestamp: datetime = field(default_factory=datetime.now)
    
    # Entry/Exit
    entry_price: Optional[float] = None
    stop_loss_pct: float = 1.0  # Default 1% stop
    target_pct: float = 2.0  # Default 2% target
    
    # Position sizing
    position_size_pct: float = 1.0  # % of portfolio
    
    # Timing
    timeframe: str = "INTRADAY"  # INTRADAY, SWING, POSITION
    urgency: str = "NORMAL"  # IMMEDIATE, NORMAL, PATIENT
    expiry: Optional[datetime] = None
    
    # Confidence and source
    confidence: float = 0.0
    sources: List[str] = field(default_factory=list)
    
    # Risk warnings
    warnings: List[str] = field(default_factory=list)


@dataclass
class TrumpExploitReport:
    """Full exploit report with actionable signals."""
    as_of: datetime = field(default_factory=datetime.now)
    
    # Signals by urgency
    immediate_signals: List[TrumpTrade] = field(default_factory=list)
    watch_signals: List[TrumpTrade] = field(default_factory=list)
    avoid_signals: List[TrumpTrade] = field(default_factory=list)
    
    # Portfolio positioning
    overall_stance: str = "NEUTRAL"  # AGGRESSIVE, NEUTRAL, DEFENSIVE
    recommended_cash_pct: float = 20.0
    
    # Summary
    top_trade: Optional[TrumpTrade] = None
    total_confidence: float = 0.0


class TrumpExploiter:
    """
    Generates actionable trading signals from Trump intelligence.
    Answers: "HOW do we profit?"
    """
    
    def __init__(self):
        self.pulse = TrumpPulse()
        self.calendar = TrumpCalendar()
        self.db = TrumpDatabase()
        self.playbook = TrumpPlaybookAnalyzer()
        logger.info("ğŸ’° TrumpExploiter initialized")
    
    def get_exploit_signals(self) -> TrumpExploitReport:
        """
        Generate actionable trading signals.
        
        Returns:
            TrumpExploitReport with all signals
        """
        report = TrumpExploitReport()
        
        # Get current situation
        situation = self.pulse.get_current_situation()
        calendar_report = self.calendar.get_upcoming_events()
        
        # Generate signals from current situation
        self._generate_pulse_signals(report, situation)
        
        # Generate signals from upcoming events
        self._generate_calendar_signals(report, calendar_report)
        
        # Generate pattern-based signals
        self._generate_pattern_signals(report)
        
        # Set overall stance
        report.overall_stance = self._determine_stance(situation, calendar_report)
        report.recommended_cash_pct = self._get_cash_recommendation(report.overall_stance)
        
        # Find top trade
        all_signals = report.immediate_signals + report.watch_signals
        if all_signals:
            report.top_trade = max(all_signals, key=lambda x: x.confidence)
            report.total_confidence = sum(s.confidence for s in all_signals) / len(all_signals)
        
        return report
    
    def _generate_pulse_signals(self, report: TrumpExploitReport, situation: TrumpSituation):
        """Generate signals from current situation."""
        
        if not situation.latest_statement:
            return
        
        # Check for actionable sentiment
        if situation.market_confidence > 60:
            if situation.market_bias == "BULLISH":
                signal = TrumpTrade(
                    signal_id=f"PULSE-{datetime.now().strftime('%Y%m%d%H%M')}",
                    action="BUY",
                    symbol="SPY",
                    reason=f"Trump sentiment bullish ({situation.sentiment_score:+.2f}). Topics: {', '.join(situation.hot_topics[:2])}",
                    stop_loss_pct=0.5,
                    target_pct=1.0,
                    position_size_pct=1.0,
                    timeframe="INTRADAY",
                    urgency="NORMAL",
                    confidence=situation.market_confidence,
                    sources=["trump_pulse"],
                    expiry=datetime.now() + timedelta(hours=4)
                )
                report.watch_signals.append(signal)
            
            elif situation.market_bias == "BEARISH":
                signal = TrumpTrade(
                    signal_id=f"PULSE-{datetime.now().strftime('%Y%m%d%H%M')}",
                    action="DEFENSIVE",
                    symbol="SPY",
                    reason=f"Trump sentiment bearish ({situation.sentiment_score:+.2f}). Topics: {', '.join(situation.hot_topics[:2])}",
                    stop_loss_pct=0.5,
                    target_pct=1.0,
                    position_size_pct=0.5,
                    timeframe="INTRADAY",
                    urgency="NORMAL",
                    confidence=situation.market_confidence,
                    sources=["trump_pulse"],
                    warnings=["Consider reducing long exposure"],
                    expiry=datetime.now() + timedelta(hours=4)
                )
                report.watch_signals.append(signal)
        
        # Check for bluff patterns
        if situation.latest_statement:
            analysis = self.playbook.analyze_statement(situation.latest_statement.summary)
            detected_patterns = analysis.get('patterns_detected', [])
            for pattern_info in detected_patterns:
                pattern = pattern_info.get('pattern')
                conf = pattern_info.get('confidence', 50) if isinstance(pattern_info, dict) else 50
                if pattern and hasattr(pattern, 'pattern_name') and 'bluff' in pattern.pattern_name.lower():
                    signal = TrumpTrade(
                        signal_id=f"BLUFF-{datetime.now().strftime('%Y%m%d%H%M')}",
                        action="FADE",
                        symbol="SPY",
                        reason=f"Playbook pattern 'Calculated Bluff' detected. FADE the initial fear reaction.",
                        stop_loss_pct=1.0,
                        target_pct=1.5,
                        position_size_pct=0.5,
                        timeframe="SWING",
                        urgency="PATIENT",
                        confidence=conf,
                        sources=["trump_playbook"],
                        warnings=["Bluffs can become real. Size small."],
                        expiry=datetime.now() + timedelta(days=7)
                    )
                    report.watch_signals.append(signal)
    
    def _generate_calendar_signals(self, report: TrumpExploitReport, calendar_report: TrumpCalendarReport):
        """Generate signals from upcoming events."""
        
        # Immediate signals for today's events
        for event in calendar_report.today:
            if event.market_impact == "HIGH":
                signal = TrumpTrade(
                    signal_id=f"CAL-{event.date.strftime('%Y%m%d%H%M')}",
                    action="PREPARE",
                    symbol=event.affected_symbols[0] if event.affected_symbols else "SPY",
                    reason=f"TODAY: {event.title}. {event.description[:100]}",
                    stop_loss_pct=1.5,
                    target_pct=2.0,
                    position_size_pct=0.5,
                    timeframe="INTRADAY",
                    urgency="IMMEDIATE",
                    confidence=event.confidence * 100,
                    sources=["trump_calendar"],
                    warnings=[f"High volatility expected around {event.date.strftime('%H:%M')}"],
                    expiry=event.date + timedelta(hours=4)
                )
                report.immediate_signals.append(signal)
        
        # Watch signals for this week
        for event in calendar_report.this_week[:3]:
            if event.market_impact in ["HIGH", "MEDIUM"]:
                signal = TrumpTrade(
                    signal_id=f"CAL-{event.date.strftime('%Y%m%d')}",
                    action="WATCH" if event.likely_direction == "UNKNOWN" else event.likely_direction,
                    symbol=event.affected_symbols[0] if event.affected_symbols else "SPY",
                    reason=f"{event.date.strftime('%m/%d')}: {event.title}",
                    stop_loss_pct=1.0,
                    target_pct=2.0,
                    position_size_pct=0.5,
                    timeframe="SWING",
                    urgency="NORMAL",
                    confidence=event.confidence * 100,
                    sources=["trump_calendar"],
                    warnings=[event.pre_event_strategy] if event.pre_event_strategy else [],
                    expiry=event.date
                )
                report.watch_signals.append(signal)
        
        # Avoid signals for high-risk periods
        if calendar_report.risk_level in ["ELEVATED", "HIGH"]:
            signal = TrumpTrade(
                signal_id=f"RISK-{datetime.now().strftime('%Y%m%d')}",
                action="REDUCE_EXPOSURE",
                symbol="ALL",
                reason=f"Risk level {calendar_report.risk_level}. Multiple high-impact events this week.",
                position_size_pct=0.0,
                timeframe="SWING",
                urgency="NORMAL",
                confidence=75.0,
                sources=["trump_calendar"],
                warnings=["Consider raising cash levels"]
            )
            report.avoid_signals.append(signal)
    
    def _generate_pattern_signals(self, report: TrumpExploitReport):
        """Generate signals from learned patterns."""
        
        # Get learned correlations
        correlations = self.db.get_all_correlations()
        
        # Get recent statements to check for pattern matches
        recent = self.db.get_recent_statements(hours=24, limit=10)
        
        for stmt in recent:
            for topic in stmt.topics:
                for corr in correlations:
                    if corr.topic.lower() == topic.lower() and corr.statement_count >= 3:
                        # High confidence pattern
                        confidence = min(100, corr.statement_count * 10)  # More samples = more confidence
                        if abs(corr.avg_spy_change_1hr) > 0.5 and confidence > 30:
                            action = "BUY" if corr.avg_spy_change_1hr > 0 else "SHORT"
                            signal = TrumpTrade(
                                signal_id=f"PATTERN-{datetime.now().strftime('%Y%m%d%H%M')}",
                                action=action,
                                symbol="SPY",
                                reason=f"Pattern match: '{topic}' historically moves SPY {corr.avg_spy_change_1hr:+.2f}% (n={corr.statement_count})",
                                stop_loss_pct=abs(corr.avg_spy_change_1hr) * 1.5,
                                target_pct=abs(corr.avg_spy_change_1hr) * 2,
                                position_size_pct=0.5,
                                timeframe="INTRADAY",
                                urgency="NORMAL",
                                confidence=confidence,
                                sources=["trump_patterns"],
                                expiry=datetime.now() + timedelta(hours=1)
                            )
                            report.watch_signals.append(signal)
    
    def _determine_stance(self, situation: TrumpSituation, calendar: TrumpCalendarReport) -> str:
        """Determine overall portfolio stance."""
        
        # High risk calendar + bearish sentiment = DEFENSIVE
        if calendar.risk_level in ["ELEVATED", "HIGH"]:
            if situation.overall_sentiment == "BEARISH":
                return "DEFENSIVE"
            return "CAUTIOUS"
        
        # Bullish sentiment with low risk = AGGRESSIVE
        if situation.overall_sentiment == "BULLISH" and situation.market_confidence > 70:
            if calendar.risk_level == "LOW":
                return "AGGRESSIVE"
            return "NEUTRAL"
        
        return "NEUTRAL"
    
    def _get_cash_recommendation(self, stance: str) -> float:
        """Get recommended cash percentage based on stance."""
        recommendations = {
            "AGGRESSIVE": 10.0,
            "NEUTRAL": 20.0,
            "CAUTIOUS": 30.0,
            "DEFENSIVE": 40.0
        }
        return recommendations.get(stance, 20.0)
    
    def print_exploit_report(self, report: Optional[TrumpExploitReport] = None):
        """Print formatted exploit report."""
        if report is None:
            report = self.get_exploit_signals()
        
        print("\n" + "=" * 70)
        print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("â•‘              ğŸ’° TRUMP EXPLOITER - TRADING SIGNALS                     â•‘")
        print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print(f"  As of: {report.as_of.strftime('%Y-%m-%d %H:%M:%S')}")
        print("=" * 70)
        
        # Overall stance
        stance_emoji = {"AGGRESSIVE": "ğŸš€", "NEUTRAL": "âœ‹", "CAUTIOUS": "âš ï¸", "DEFENSIVE": "ğŸ›¡ï¸"}.get(report.overall_stance, "â“")
        print(f"\n{stance_emoji} OVERALL STANCE: {report.overall_stance}")
        print(f"   Recommended Cash: {report.recommended_cash_pct:.0f}%")
        
        # Top trade
        if report.top_trade:
            print(f"\nğŸ¯ TOP TRADE (Confidence: {report.top_trade.confidence:.0f}%):")
            self._print_trade(report.top_trade, indent=3)
        
        # Immediate signals
        print(f"\nğŸš¨ IMMEDIATE SIGNALS ({len(report.immediate_signals)}):")
        if report.immediate_signals:
            for signal in report.immediate_signals:
                self._print_trade(signal, indent=3)
        else:
            print("   No immediate signals")
        
        # Watch signals
        print(f"\nğŸ‘€ WATCH LIST ({len(report.watch_signals)}):")
        if report.watch_signals:
            for signal in report.watch_signals[:5]:
                self._print_trade(signal, indent=3)
        else:
            print("   No watch signals")
        
        # Avoid signals
        print(f"\nâ›” AVOID / REDUCE ({len(report.avoid_signals)}):")
        if report.avoid_signals:
            for signal in report.avoid_signals:
                self._print_trade(signal, indent=3)
        else:
            print("   No avoid signals")
        
        print("\n" + "=" * 70)
    
    def _print_trade(self, trade: TrumpTrade, indent: int = 0):
        """Print a single trade signal."""
        pad = " " * indent
        
        action_emoji = {
            "BUY": "ğŸŸ¢", "SELL": "ğŸ”´", "SHORT": "ğŸ”´",
            "COVER": "ğŸŸ¢", "FADE": "ğŸ”„", "AVOID": "â›”",
            "WATCH": "ğŸ‘€", "PREPARE": "âš ï¸", "DEFENSIVE": "ğŸ›¡ï¸",
            "REDUCE_EXPOSURE": "ğŸ“‰"
        }.get(trade.action, "â“")
        
        print(f"{pad}{action_emoji} {trade.action} {trade.symbol} ({trade.confidence:.0f}% conf)")
        print(f"{pad}   {trade.reason}")
        
        if trade.stop_loss_pct and trade.target_pct:
            print(f"{pad}   Stop: {trade.stop_loss_pct:.1f}% | Target: {trade.target_pct:.1f}% | Size: {trade.position_size_pct:.1f}%")
        
        if trade.warnings:
            for warning in trade.warnings:
                print(f"{pad}   âš ï¸ {warning}")


def main():
    """Demo the Trump Exploiter."""
    logging.basicConfig(level=logging.INFO, format="%(message)s")
    
    exploiter = TrumpExploiter()
    report = exploiter.get_exploit_signals()
    exploiter.print_exploit_report(report)


if __name__ == "__main__":
    main()

