#!/usr/bin/env python3
"""
TRUMP EXPLOIT ENGINE - THE ULTIMATE SYSTEM
==========================================
Combines:
1. DATA-DRIVEN learning from historical market reactions
2. PLAYBOOK-BASED predictions from "Art of the Deal"

This is the killer combination - we're using both his revealed
psychology AND actual market data to predict and profit.
"""

import os
import sys
from datetime import datetime, timedelta
from pathlib import Path
from typing import Dict, List, Optional, Tuple
from dataclasses import dataclass
import logging

# Add paths
sys.path.insert(0, str(Path(__file__).parent))

from trump_data_models import TrumpStatement, TrumpSignal, StatementSource
from trump_database import TrumpDatabase
from trump_pattern_agent import TrumpPatternAgent
from trump_playbook import TrumpPlaybookAnalyzer

logger = logging.getLogger(__name__)


@dataclass
class ExploitSignal:
    """Combined signal from both data + playbook analysis"""
    timestamp: datetime
    statement_text: str
    
    # Data-driven analysis
    data_direction: str  # BULLISH, BEARISH, NEUTRAL
    data_magnitude: float
    data_confidence: float
    data_reasoning: str
    similar_statements_count: int
    
    # Playbook analysis
    playbook_patterns: List[str]
    playbook_principle: str
    playbook_confidence: float
    playbook_prediction: str
    counter_strategy: str
    
    # Combined signal
    combined_direction: str
    combined_confidence: float
    combined_reasoning: str
    
    # Trading action
    should_trade: bool
    symbols: List[str]
    entry_strategy: str
    position_size: float
    stop_loss_pct: float
    target_pct: float


class TrumpExploitEngine:
    """
    The Ultimate Trump Exploitation System
    
    Uses BOTH:
    1. Historical data patterns (what actually moved markets)
    2. Psychological playbook (how he thinks and operates)
    """
    
    def __init__(self, db: TrumpDatabase = None):
        self.db = db or TrumpDatabase()
        self.pattern_agent = TrumpPatternAgent(db=self.db)
        self.playbook = TrumpPlaybookAnalyzer()
        
        logger.info("ðŸŽ¯ Trump Exploit Engine initialized")
        logger.info("   ðŸ“Š Data-driven pattern agent: READY")
        logger.info("   ðŸ“– Playbook analyzer: READY")
    
    def analyze_statement(self, text: str, timestamp: datetime = None) -> ExploitSignal:
        """
        Complete analysis of a Trump statement using both systems
        """
        if timestamp is None:
            timestamp = datetime.now()
        
        # Create temporary statement for analysis
        stmt = TrumpStatement(
            id=TrumpStatement.generate_id(text, timestamp),
            timestamp=timestamp,
            source=StatementSource.NEWS,
            raw_text=text
        )
        
        # Get keyword-based features
        from trump_collector_agent import TrumpCollectorAgent
        collector = TrumpCollectorAgent(db=self.db)
        features = collector.extract_features(text)
        stmt.topics = features.get('topics', [])
        stmt.entities = features.get('entities', [])
        stmt.sentiment = features.get('sentiment', 0.0)
        stmt.intensity = features.get('intensity', 0.0)
        
        # 1. DATA-DRIVEN ANALYSIS
        data_prediction = self.pattern_agent.predict_impact(stmt)
        
        # 2. PLAYBOOK ANALYSIS
        playbook_analysis = self.playbook.analyze_statement(text)
        counter_strategy = self.playbook.get_counter_strategy(
            playbook_analysis.get('primary_pattern', '')
        )
        
        # 3. COMBINE THE SIGNALS
        combined = self._combine_signals(data_prediction, playbook_analysis)
        
        # 4. GENERATE TRADING SIGNAL
        signal = ExploitSignal(
            timestamp=timestamp,
            statement_text=text,
            
            # Data-driven
            data_direction=data_prediction['direction'],
            data_magnitude=data_prediction['magnitude'],
            data_confidence=data_prediction['confidence'],
            data_reasoning=data_prediction['reasoning'],
            similar_statements_count=data_prediction['similar_count'],
            
            # Playbook
            playbook_patterns=playbook_analysis.get('patterns_detected', []),
            playbook_principle=playbook_analysis.get('principle', 'unknown'),
            playbook_confidence=playbook_analysis.get('confidence', 0.3),
            playbook_prediction=playbook_analysis.get('prediction', 'No pattern detected'),
            counter_strategy=counter_strategy,
            
            # Combined
            combined_direction=combined['direction'],
            combined_confidence=combined['confidence'],
            combined_reasoning=combined['reasoning'],
            
            # Trading
            should_trade=combined['confidence'] >= 0.6,
            symbols=self._get_affected_symbols(stmt, playbook_analysis),
            entry_strategy=combined['entry_strategy'],
            position_size=self._calculate_position_size(combined['confidence']),
            stop_loss_pct=combined.get('stop_loss', 0.5),
            target_pct=combined.get('target', 1.0)
        )
        
        return signal
    
    def _combine_signals(self, data: Dict, playbook: Dict) -> Dict:
        """
        Combine data-driven and playbook signals
        
        Rules:
        - If both agree: HIGH confidence
        - If playbook suggests fade: Consider contrarian play
        - If data is strong but playbook says bluff: Reduce confidence
        """
        data_direction = data['direction']
        data_confidence = data['confidence']
        
        playbook_pattern = playbook.get('primary_pattern', '')
        playbook_confidence = playbook.get('confidence', 0.3)
        
        # Playbook patterns that suggest FADING the initial move
        fade_patterns = ['Opening Gambit', 'Calculated Bluff', 'Truthful Hyperbole', 
                        'Manufactured Deadline', 'Economic Self-Interest']
        
        # Playbook patterns that suggest the move is REAL
        real_patterns = ['Personal Retaliation', 'Multi-Front Assault']
        
        reasoning_parts = []
        
        if playbook_pattern in fade_patterns:
            # Playbook suggests this is a bluff - consider fading
            if data_direction == "BEARISH":
                # Data says bearish, but playbook says it's a bluff
                combined_direction = "BULLISH"  # Fade the fear
                combined_confidence = (data_confidence + playbook_confidence) / 2
                entry_strategy = "FADE: Wait for initial drop, then BUY the dip"
                reasoning_parts.append(f"Data shows bearish ({data_direction}), but playbook pattern '{playbook_pattern}' suggests this is a bluff")
                reasoning_parts.append("Strategy: Fade the initial fear reaction")
            elif data_direction == "BULLISH":
                # Both say good
                combined_direction = "BULLISH"
                combined_confidence = max(data_confidence, playbook_confidence)
                entry_strategy = "BUY on confirmation"
                reasoning_parts.append("Data and playbook both suggest positive outcome")
            else:
                combined_direction = "NEUTRAL"
                combined_confidence = 0.4
                entry_strategy = "WAIT for clarity"
                reasoning_parts.append("Mixed signals - wait for more information")
                
        elif playbook_pattern in real_patterns:
            # Playbook suggests this is a real threat
            combined_direction = data_direction
            combined_confidence = (data_confidence + playbook_confidence) / 2 + 0.1
            entry_strategy = f"FOLLOW: Trade {data_direction} with conviction"
            reasoning_parts.append(f"Playbook pattern '{playbook_pattern}' suggests this is real")
            reasoning_parts.append(f"Data supports: {data_direction} ({data_confidence:.0%})")
            
        elif playbook_pattern == 'Symbolic Victory':
            # He's trying to claim a win
            combined_direction = "BULLISH"
            combined_confidence = playbook_confidence
            entry_strategy = "BUY the rumor, SELL the news"
            reasoning_parts.append("Symbolic Victory pattern detected - expect positive spin")
            
        else:
            # Default: trust the data more
            combined_direction = data_direction
            combined_confidence = data_confidence
            entry_strategy = f"DATA-DRIVEN: {data_direction} based on historical patterns"
            reasoning_parts.append(f"Using data-driven prediction: {data_direction}")
        
        # Adjust confidence based on data sample size
        if data.get('similar_count', 0) >= 5:
            combined_confidence += 0.1
            reasoning_parts.append(f"High confidence: {data['similar_count']} similar historical statements")
        
        # Cap confidence
        combined_confidence = min(combined_confidence, 0.95)
        
        return {
            'direction': combined_direction,
            'confidence': combined_confidence,
            'reasoning': ". ".join(reasoning_parts),
            'entry_strategy': entry_strategy,
            'stop_loss': 0.5 if combined_confidence > 0.7 else 0.75,
            'target': 1.0 if combined_confidence > 0.7 else 0.75
        }
    
    def _get_affected_symbols(self, stmt: TrumpStatement, playbook: Dict) -> List[str]:
        """Determine which symbols to trade"""
        symbols = ['SPY']  # Always include SPY
        
        # Add based on entities
        entity_map = {
            'China': ['FXI', 'BABA', 'KWEB'],
            'Mexico': ['EWW'],
            'Canada': ['EWC'],
            'EU': ['VGK', 'EZU'],
            'Russia': ['RSX'],
            'AAPL': ['AAPL'],
            'AMZN': ['AMZN'],
            'GOOGL': ['GOOGL'],
            'MSFT': ['MSFT'],
            'TSLA': ['TSLA'],
            'NVDA': ['NVDA']
        }
        
        for entity in stmt.entities:
            if entity in entity_map:
                symbols.extend(entity_map[entity])
        
        # Add based on topics
        if 'tariff' in stmt.topics:
            symbols.extend(['FXI', 'EWW'])  # Major tariff targets
        if 'fed' in stmt.topics:
            symbols.extend(['TLT', 'XLF'])
        if 'energy' in stmt.topics:
            symbols.extend(['XLE', 'USO'])
        
        return list(set(symbols))
    
    def _calculate_position_size(self, confidence: float) -> float:
        """Calculate position size based on confidence"""
        if confidence >= 0.8:
            return 0.03  # 3%
        elif confidence >= 0.7:
            return 0.02  # 2%
        elif confidence >= 0.6:
            return 0.01  # 1%
        else:
            return 0.0  # Don't trade
    
    def generate_exploit_brief(self, text: str) -> str:
        """Generate a complete exploitation brief"""
        signal = self.analyze_statement(text)
        
        brief = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ðŸŽ¯ TRUMP EXPLOIT ENGINE - COMBINED ANALYSIS                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“ STATEMENT:
"{signal.statement_text[:150]}..."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“Š DATA-DRIVEN ANALYSIS (Historical Pattern Matching)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Direction:    {signal.data_direction}
Magnitude:    {signal.data_magnitude:.2f}%
Confidence:   {signal.data_confidence:.0%}
Similar:      {signal.similar_statements_count} historical statements
Reasoning:    {signal.data_reasoning}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“– PLAYBOOK ANALYSIS (Art of the Deal Psychology)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Patterns:     {', '.join(signal.playbook_patterns) if signal.playbook_patterns else 'None detected'}
Principle:    {signal.playbook_principle.upper() if signal.playbook_principle != 'unknown' else 'N/A'}
Confidence:   {signal.playbook_confidence:.0%}

{signal.playbook_prediction}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŽ¯ COMBINED SIGNAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DIRECTION:    {signal.combined_direction}
CONFIDENCE:   {signal.combined_confidence:.0%}
SHOULD TRADE: {'âœ… YES' if signal.should_trade else 'âŒ NO'}

REASONING:
{signal.combined_reasoning}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ’° TRADING STRATEGY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Entry:        {signal.entry_strategy}
Symbols:      {', '.join(signal.symbols)}
Position:     {signal.position_size:.1%} of portfolio
Stop Loss:    {signal.stop_loss_pct:.1f}%
Target:       {signal.target_pct:.1f}%

{signal.counter_strategy}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
        return brief
    
    def quick_check(self, text: str) -> Dict:
        """Quick check for Discord alerts"""
        signal = self.analyze_statement(text)
        
        return {
            'direction': signal.combined_direction,
            'confidence': signal.combined_confidence,
            'should_trade': signal.should_trade,
            'symbols': signal.symbols,
            'entry_strategy': signal.entry_strategy,
            'reasoning': signal.combined_reasoning,
            'playbook_pattern': signal.playbook_patterns[0] if signal.playbook_patterns else None
        }


def _demo():
    """Demo the exploit engine"""
    logging.basicConfig(level=logging.INFO, format='%(message)s')
    
    engine = TrumpExploitEngine()
    
    print("=" * 70)
    print("ðŸŽ¯ TRUMP EXPLOIT ENGINE - DEMO")
    print("=" * 70)
    
    # Test statements
    statements = [
        "Trump threatens 100% tariff on BRICS countries if they create new currency",
        "Trump says he will impose the biggest tariffs ever seen unless China makes a deal before deadline",
        "Trump announces historic trade deal with Mexico, calls it tremendous victory for American workers",
        "Trump attacks Amazon, says company is a disaster for American jobs"
    ]
    
    for stmt in statements:
        print("\n" + "=" * 70)
        brief = engine.generate_exploit_brief(stmt)
        print(brief)


if __name__ == "__main__":
    _demo()


