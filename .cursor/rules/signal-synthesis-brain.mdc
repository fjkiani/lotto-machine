# Signal Synthesis Brain - The Thinking Layer

## The Problem (What Alpha Identified)

### Problem 1: Signals are SILOED
- DP alerts fire independently
- Fed Watch alerts fire independently  
- Trump alerts fire independently
- Economic calendar alerts fire independently

### Problem 2: TOO MANY ALERTS
At 3:06 PM, 7 alerts fired simultaneously:
```
SPY @ $685.34 (725K shares)
SPY @ $684.43 (760K shares)
SPY @ $684.41 (1.17M shares)
SPY @ $684.39 (1.02M shares)
SPY @ $683.67 (2.9M shares)
QQQ @ $623.46 (620K shares)
QQQ @ $622.94 (515K shares)
```
**User cannot act on 7 alerts at once!**

### Problem 3: LEVEL CLUSTERING NOT DETECTED
$684.39, $684.41, $684.43 are within $0.04 (0.006%) - this is ONE ZONE!
Combined volume: 2.95M shares - should be treated as SINGLE strong support!

### Problem 4: NO PRIORITY
Which of 7 alerts is most important? The $683.67 with 2.9M shares should be PRIMARY.

### Problem 5: NO CROSS-ASSET SYNTHESIS
SPY at support + QQQ at support = STRONG confirmation. But they fire separately.

### Problem 6: MISSING CONTEXT
- Overall trend (up/down/sideways)
- Time of day (open/mid/close)
- VIX level
- Recent price action (last 30 min)
- Fed/Trump sentiment

### Problem 7: NO UNIFIED ACTION
7 separate trade setups = paralysis. Need ONE clear recommendation.

## The Solution: Signal Synthesis Brain

A **thinking layer** that:
1. **Clusters** nearby levels into ZONES (within 0.1% = same zone)
2. **Prioritizes** by volume significance (PRIMARY, SECONDARY, TERTIARY)
3. **Correlates** cross-asset signals (SPY + QQQ at support = CONFIRMS)
4. **Adds Context** (trend, VIX, Fed, time of day)
5. **Outputs ONE** unified recommendation (not 7 separate alerts)
6. **Explains** the full reasoning

## NEW: Zone Clustering Logic

### The Problem:
```
$684.39 - 1,024,095 shares
$684.41 - 1,169,285 shares  
$684.43 - 760,913 shares
```
These are 3 separate alerts but they're ONE ZONE!

### The Solution:
```python
def cluster_levels(levels: List[float], threshold_pct: float = 0.10):
    """
    Cluster levels within threshold % of each other.
    $684.39, $684.41, $684.43 â†’ ONE zone at $684.41 (midpoint)
    with combined volume of 2.95M shares
    """
    zones = []
    used = set()
    
    for level in sorted(levels):
        if level in used:
            continue
            
        # Find all levels within threshold
        zone_levels = [l for l in levels if abs(l - level)/level <= threshold_pct/100]
        
        if len(zone_levels) > 1:
            # Cluster found!
            zone = {
                'center': statistics.mean(zone_levels),
                'min': min(zone_levels),
                'max': max(zone_levels),
                'levels': zone_levels,
                'combined_volume': sum(level_volumes[l] for l in zone_levels),
                'count': len(zone_levels),
            }
            zones.append(zone)
            used.update(zone_levels)
        else:
            # Single level
            zones.append({
                'center': level,
                'min': level,
                'max': level,
                'levels': [level],
                'combined_volume': level_volumes[level],
                'count': 1,
            })
            used.add(level)
    
    return zones
```

### Result:
```
BEFORE: 5 separate SPY alerts
AFTER:
  ZONE 1: $683.67 (2.9M shares) - MAJOR
  ZONE 2: $684.39-684.43 (3.0M combined) - MAJOR  
  ZONE 3: $685.34 (725K) - MODERATE
```

## NEW: Priority Ranking

### Volume-Based Priority:
```python
def rank_zones(zones: List[dict]) -> List[dict]:
    """
    Rank zones by importance.
    """
    for zone in zones:
        vol = zone['combined_volume']
        if vol >= 2_000_000:
            zone['rank'] = 'PRIMARY'
            zone['importance'] = 1
        elif vol >= 1_000_000:
            zone['rank'] = 'SECONDARY'
            zone['importance'] = 2
        else:
            zone['rank'] = 'TERTIARY'
            zone['importance'] = 3
    
    return sorted(zones, key=lambda x: x['importance'])
```

### Output:
```
ğŸ“ SUPPORT STRUCTURE (by importance):
   PRIMARY:   $683.67 (2.9M) - Major institutional support
   PRIMARY:   $684.40 zone (3.0M) - Strong accumulation zone
   SECONDARY: $685.34 (725K) - Current price level
```

## NEW: Cross-Asset Correlation

### Detection:
```python
def detect_cross_asset_confluence(spy_state, qqq_state):
    """
    Check if SPY and QQQ are giving same signal.
    Both at support = STRONG confirmation.
    """
    spy_at_support = spy_state.nearest_support_distance < 0.5  # Within 0.5%
    qqq_at_support = qqq_state.nearest_support_distance < 0.5
    
    if spy_at_support and qqq_at_support:
        return {
            'confluence': 'STRONG',
            'message': 'Both SPY and QQQ at support zones',
            'boost': 0.20  # Add 20% to confluence score
        }
    elif spy_at_support != qqq_at_support:
        return {
            'confluence': 'DIVERGENT',
            'message': 'SPY and QQQ showing different signals',
            'penalty': 0.10  # Reduce confidence
        }
    
    return {'confluence': 'NEUTRAL'}
```

## NEW: Context Enrichment

### Required Context:
```python
@dataclass
class MarketContext:
    # Price Context
    spy_price: float
    spy_trend_1h: str   # UP/DOWN/SIDEWAYS
    spy_trend_1d: str
    spy_change_today: float
    
    # Volatility
    vix_level: float
    vix_trend: str  # RISING/FALLING/STABLE
    
    # Time Context
    time_of_day: str  # OPEN/MIDDAY/POWER_HOUR/CLOSE
    minutes_to_close: int
    
    # Macro Context
    fed_sentiment: str  # HAWKISH/DOVISH/NEUTRAL
    trump_risk_level: str  # HIGH/MEDIUM/LOW
    
    # Recent Activity
    last_30min_range: float
    volume_vs_avg: float  # 1.5 = 50% above average
```

### Time of Day Context:
```python
def get_time_context():
    now = datetime.now(eastern)
    
    if now.hour == 9 and now.minute < 45:
        return 'OPEN'  # High volatility, breakouts
    elif now.hour >= 15:
        return 'POWER_HOUR'  # Institutional activity
    elif now.hour >= 11 and now.hour < 14:
        return 'MIDDAY'  # Choppy, avoid
    else:
        return 'REGULAR'
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SIGNAL SOURCES (Existing)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    DP    â”‚   Fed    â”‚  Trump   â”‚   Econ   â”‚    News        â”‚
â”‚  Levels  â”‚  Watch   â”‚  Intel   â”‚  Calendarâ”‚   Sentiment    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚          â”‚          â”‚          â”‚             â”‚
     â–¼          â–¼          â–¼          â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 1: SIGNAL COLLECTOR                      â”‚
â”‚  - Stores all signals in rolling 30-min window              â”‚
â”‚  - Tags with timestamp, symbol, type, direction             â”‚
â”‚  - Maintains "signal state" per symbol                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 2: PATTERN DETECTOR                      â”‚
â”‚  - Detects signal clusters (multiple signals in 5 min)      â”‚
â”‚  - Identifies level tests (above/below same level)          â”‚
â”‚  - Tracks signal momentum (accelerating vs fading)          â”‚
â”‚  - Correlates cross-asset signals (SPY + QQQ + VIX)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 3: CONFLUENCE SCORER                     â”‚
â”‚  - Calculates multi-factor confluence score                 â”‚
â”‚  - Weights: DP (40%) + Fed (20%) + Trump (15%) + News (15%) â”‚
â”‚  - Bonus for cross-asset agreement (+20%)                   â”‚
â”‚  - Penalty for conflicting signals (-30%)                   â”‚
â”‚  - Output: STRONG/MEDIUM/WEAK/CONFLICTING                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 4: LLM SYNTHESIS (Optional)              â”‚
â”‚  - Only triggered when confluence >= MEDIUM                 â”‚
â”‚  - Receives: All signals + context + historical patterns    â”‚
â”‚  - Outputs: Narrative + Trade Idea + Confidence + Risks     â”‚
â”‚  - Model: GPT-4 or Claude (fast, cheap tier)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LAYER 5: ACTION GENERATOR                      â”‚
â”‚  - Only fires when confluence is STRONG                     â”‚
â”‚  - Generates unified alert with full context                â”‚
â”‚  - Includes: All contributing signals + reasoning           â”‚
â”‚  - Tracks: Which synthesis led to profit/loss               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Example: Real Alert Stream (Your 3:06 PM Alerts)

### Current (7 Siloed Alerts):
```
3:06 PM: ğŸš¨ SPY AT $685.34 (725K) - LONG
3:06 PM: âš ï¸ SPY APPROACHING $684.43 (760K) - LONG
3:06 PM: âš ï¸ SPY APPROACHING $684.41 (1.17M) - LONG
3:06 PM: âš ï¸ SPY APPROACHING $684.39 (1.02M) - LONG
3:06 PM: ğŸ“Š SPY near $683.67 (2.9M) - LONG
3:06 PM: ğŸ“Š QQQ near $623.46 (620K) - LONG
3:06 PM: ğŸ“Š QQQ near $622.94 (515K) - LONG
```
**Result: Paralysis. Which one do I act on???**

### With Synthesis Brain (1 Unified Alert):
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ§  MARKET SYNTHESIS: SPY + QQQ | 3:06 PM (Power Hour)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“ SUPPORT STRUCTURE (Zone Analysis):
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ğŸ”¥ PRIMARY: $683.67 (2.9M shares) - MAJOR SUPPORT     â”‚
   â”‚ ğŸ”¥ PRIMARY: $684.40 zone (3.0M) - Strong accumulation â”‚
   â”‚ âš¡ CURRENT: $685.34 (725K) - Price testing here       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   QQQ Support: $622-624 zone (1.1M combined) âœ… CONFIRMS

ğŸ“Š CONFLUENCE SCORE: 85% BULLISH
   âœ… DP Levels: Multiple strong support zones stacked
   âœ… Cross-Asset: SPY + QQQ both at support (STRONG)
   âœ… Volume: High institutional accumulation (5.9M shares)
   âš ï¸ Distance: Not yet testing primary support
   ğŸ• Time: Power Hour (institutional activity high)

ğŸ’­ SYNTHESIS (The Thinking):
   "SPY has LAYERED SUPPORT structure with two major zones:
   $683.67 (2.9M) and the $684.40 cluster (3.0M combined).
   QQQ showing same pattern confirms cross-asset strength.
   Price is currently at weaker $685.34 level. If this breaks,
   next test is the strong $684.40 zone with 3M shares - 
   HIGH probability of bounce there."

ğŸ¯ THE TRADE (ONE Action):
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WAIT for price to test $684.40 zone                   â”‚
   â”‚                                                        â”‚
   â”‚ Entry:  $684.50 (on bounce confirmation)              â”‚
   â”‚ Stop:   $683.00 (below major $683.67 support)         â”‚
   â”‚ Target: $688.00 (2.6% reward)                         â”‚
   â”‚ R/R:    2.8:1                                         â”‚
   â”‚ Size:   FULL (high confluence)                        â”‚
   â”‚                                                        â”‚
   â”‚ Why this level: Combined 3M shares + QQQ confirms     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ RISKS TO WATCH:
   - If $683.67 breaks â†’ Major support failure â†’ EXIT
   - Fed speakers today â†’ Could add volatility
   - Near market close â†’ Watch for EOD positioning

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Result: ONE clear action with full reasoning!**

## Signal State Tracking

### Per-Symbol State:
```python
class SymbolState:
    symbol: str
    
    # Price context
    current_price: float
    price_trend: str  # UP/DOWN/SIDEWAYS
    volatility: float
    
    # DP context
    nearest_support: float
    nearest_resistance: float
    support_touches_5min: int
    resistance_touches_5min: int
    level_being_tested: Optional[float]
    
    # Macro context
    fed_sentiment: str  # HAWKISH/NEUTRAL/DOVISH
    trump_risk: str     # HIGH/MEDIUM/LOW
    news_sentiment: str # BULLISH/BEARISH/NEUTRAL
    vix_level: float
    
    # Confluence
    overall_bias: str   # BULLISH/BEARISH/NEUTRAL
    confluence_score: float
    conflicting_signals: List[str]
```

### Level Test Detection:
```python
def detect_level_test(signals: List[Signal], window_min: int = 5):
    """
    Detect when price is testing a level (oscillating around it)
    """
    level_touches = {}
    
    for signal in signals:
        if signal.age_min <= window_min:
            level = signal.level_price
            if level not in level_touches:
                level_touches[level] = {'above': 0, 'below': 0}
            
            if signal.is_above_level:
                level_touches[level]['above'] += 1
            else:
                level_touches[level]['below'] += 1
    
    # Level test = at least 1 above AND 1 below in the window
    for level, counts in level_touches.items():
        if counts['above'] >= 1 and counts['below'] >= 1:
            return {
                'level': level,
                'total_touches': counts['above'] + counts['below'],
                'pattern': 'LEVEL_TEST',  # vs CLEAN_BREAK or CLEAN_BOUNCE
            }
    
    return None
```

## Confluence Scoring

### Weights:
```python
CONFLUENCE_WEIGHTS = {
    'dp_signals': 0.40,      # Dark pool is primary
    'fed_sentiment': 0.20,   # Fed matters for direction
    'trump_risk': 0.10,      # Trump adds volatility
    'news_sentiment': 0.15,  # News for context
    'cross_asset': 0.15,     # SPY + QQQ + VIX agreement
}
```

### Scoring Logic:
```python
def calculate_confluence(state: SymbolState) -> float:
    score = 0.0
    direction = state.dp_bias  # Primary direction from DP
    
    # DP Score (40%)
    if state.support_touches_5min >= 2 and direction == 'LONG':
        score += 0.40  # Strong DP support
    elif state.resistance_touches_5min >= 2 and direction == 'SHORT':
        score += 0.40  # Strong DP resistance
    else:
        score += 0.20  # Weak DP signal
    
    # Fed Score (20%)
    if (direction == 'LONG' and state.fed_sentiment == 'DOVISH') or \
       (direction == 'SHORT' and state.fed_sentiment == 'HAWKISH'):
        score += 0.20  # Fed aligns
    elif state.fed_sentiment == 'NEUTRAL':
        score += 0.10  # Fed neutral
    else:
        score -= 0.10  # Fed conflicts
    
    # Trump Risk (10%)
    if state.trump_risk == 'LOW':
        score += 0.10
    elif state.trump_risk == 'MEDIUM':
        score += 0.05
    else:
        score -= 0.05  # High Trump risk = penalty
    
    # News Sentiment (15%)
    if (direction == 'LONG' and state.news_sentiment == 'BULLISH') or \
       (direction == 'SHORT' and state.news_sentiment == 'BEARISH'):
        score += 0.15
    elif state.news_sentiment == 'NEUTRAL':
        score += 0.07
    
    # Cross-Asset Agreement (15%)
    # SPY + QQQ should agree
    if state.cross_asset_agreement:
        score += 0.15
    
    return min(max(score, 0.0), 1.0)
```

## LLM Integration (Optional Layer)

### When to Call LLM:
- Confluence score >= 0.50 (MEDIUM)
- At least 3 signals in 5-min window
- New level test detected
- Major macro event + DP signal

### LLM Prompt:
```
You are a professional trader analyzing market signals.

CURRENT SITUATION:
Symbol: {symbol}
Price: ${price}
Nearest Support: ${support} (DP volume: {vol})
Nearest Resistance: ${resistance}

RECENT SIGNALS (last 5 minutes):
{signals_json}

MACRO CONTEXT:
Fed Sentiment: {fed}
Trump Risk: {trump}
News: {news}
VIX: {vix}

HISTORICAL PATTERN:
This level has held {hold_rate}% of the time
Average bounce: {avg_bounce}%
Similar setups: {similar_patterns}

TASK:
1. Synthesize all signals into a coherent narrative
2. Identify any conflicting signals
3. Determine the most likely outcome
4. Provide a trade recommendation with confidence level
5. Highlight key risks

Output as JSON:
{
  "narrative": "...",
  "bias": "BULLISH/BEARISH/NEUTRAL",
  "confidence": 0-100,
  "trade": {
    "action": "LONG/SHORT/WAIT",
    "entry": ...,
    "stop": ...,
    "target": ...,
    "size": "FULL/HALF/QUARTER"
  },
  "risks": ["..."],
  "key_factor": "The most important signal that drove this decision"
}
```

## Implementation Plan (Updated)

### Phase 1: Zone Clustering (1.5 hours)
- Create `signal_brain/zone_clustering.py`
- Cluster levels within 0.1% of each other
- Calculate combined volume per zone
- Rank zones: PRIMARY/SECONDARY/TERTIARY

### Phase 2: Context Enrichment (2 hours)
- Create `signal_brain/context.py`
- Fetch: VIX, trend, time of day
- Integrate: Fed sentiment, Trump risk
- Calculate: volume vs average, recent range

### Phase 3: Cross-Asset Correlation (1.5 hours)
- Create `signal_brain/cross_asset.py`
- Correlate SPY + QQQ signals
- Detect: CONFIRMS, DIVERGENT, NEUTRAL
- Boost/penalty for confluence score

### Phase 4: Confluence Scorer (2 hours)
- Create `signal_brain/confluence.py`
- Weighted scoring with all inputs
- Output: Score + Bias + Conflicts

### Phase 5: Unified Synthesizer (3 hours)
- Create `signal_brain/synthesizer.py`
- ONE alert per symbol group
- Full reasoning (The Thinking)
- Clear trade recommendation
- Risk warnings

### Phase 6: LLM Enhancement (Optional, 3 hours)
- Create `signal_brain/llm_layer.py`
- Only when confluence >= 70%
- Add narrative explanation
- Fallback to rule-based

## Directory Structure

```
live_monitoring/agents/signal_brain/
â”œâ”€â”€ __init__.py              # Package exports
â”œâ”€â”€ models.py                # Data contracts (~100 lines)
â”œâ”€â”€ zone_clustering.py       # Level clustering (~80 lines)
â”œâ”€â”€ context.py               # Market context (~120 lines)
â”œâ”€â”€ cross_asset.py           # SPY/QQQ correlation (~60 lines)
â”œâ”€â”€ confluence.py            # Confluence scoring (~150 lines)
â”œâ”€â”€ synthesizer.py           # Unified alert generation (~200 lines)
â”œâ”€â”€ llm_layer.py             # Optional LLM (~150 lines)
â””â”€â”€ engine.py                # Main orchestrator (~150 lines)

Total: ~1000 lines in 9 modular files
```

## Success Criteria

### Alert Quality:
1. âœ… **Zone clustering works** - 3 levels at $684.40 â†’ ONE zone alert
2. âœ… **Cross-asset correlation** - SPY + QQQ at support â†’ CONFIRMS
3. âœ… **ONE unified alert** - Not 7 separate alerts
4. âœ… **Clear priority** - PRIMARY/SECONDARY/TERTIARY zones
5. âœ… **Full context** - Trend, VIX, Fed, time of day included

### Trade Quality:
6. âœ… **ONE clear action** - Not 7 trade setups
7. âœ… **Clear reasoning** - WHY this level, WHY this size
8. âœ… **Risk warnings** - What could go wrong
9. âœ… **Confidence-based sizing** - Higher confluence = larger size

### User Experience:
10. âœ… **Actionable** - User knows exactly what to do
11. âœ… **No paralysis** - Not overwhelmed with alerts
12. âœ… **Full picture** - All context in one view

## Example Output

### Before (Siloed):
```
3:00 PM: SPY near $685.34 SUPPORT
3:01 PM: SPY at $685.34 SUPPORT  
3:02 PM: Fed: Hawkish comment
3:03 PM: SPY below $685.34 RESISTANCE
3:04 PM: SPY above $685.34 SUPPORT
```

### After (Synthesized):
```
ğŸ§  SIGNAL SYNTHESIS: SPY

ğŸ“ LEVEL TEST DETECTED
   $685.34 has been touched 4 times in 5 minutes
   Pattern: Price oscillating around support
   Institutional volume: 725K shares

ğŸ”— SIGNAL CONFLUENCE: 65% BULLISH
   âœ… DP: Multiple support bounces (BULLISH)
   âš ï¸ Fed: Hawkish tone (NEUTRAL/BEARISH)
   âœ… Cross-Asset: QQQ also at support (CONFIRMS)

ğŸ’­ SYNTHESIS:
   "Price is respecting the $685.34 institutional level
   despite Fed hawkishness. Multiple bounces suggest
   strong buying interest. The level has held 78% of
   the time historically."

ğŸ¯ TRADE RECOMMENDATION:
   Action: LONG on next touch of $685.34
   Entry: $685.40 | Stop: $684.90 | Target: $687.00
   Size: 75% (due to Fed headwind)
   Confidence: 65%
```

---

**ALPHA'S INSIGHT:** 
*"Signals that don't talk to each other are just noise. The edge is in the synthesis."*
