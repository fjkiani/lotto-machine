#!/usr/bin/env python3
"""
ğŸ¦ FED EXPLOITATION MONITOR - Be First on Every Fed Move!

Continuously monitors:
1. CME FedWatch probabilities - Alert on 5%+ changes
2. Fed official comments - Alert when ANY FOMC member speaks about rates

THIS IS THE EDGE: When Powell says "we're watching data" and FedWatch moves 10%,
we get a Discord alert in SECONDS.

Usage:
    python3 run_fed_exploitation_monitor.py
    python3 run_fed_exploitation_monitor.py --once  # Single scan

Environment:
    PERPLEXITY_API_KEY: For news fetching
    DISCORD_WEBHOOK_URL: For alerts
"""

import os
import sys
import time
import logging
import requests
from datetime import datetime, timedelta
from dotenv import load_dotenv

# Load environment
load_dotenv()

# Add paths
base_path = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, base_path)

from live_monitoring.agents.fed_watch_monitor import FedWatchMonitor, FedWatchStatus
from live_monitoring.agents.fed_officials_monitor import FedOfficialsMonitor, FedCommentReport

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s | %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)
logger = logging.getLogger(__name__)


class FedExploitationMonitor:
    """
    Unified Fed exploitation monitor - tracks both probabilities and officials.
    """
    
    def __init__(
        self,
        check_interval: int = 300,  # 5 minutes
        prob_alert_threshold: float = 5.0,  # 5% change triggers alert
        discord_webhook: str = None
    ):
        self.check_interval = check_interval
        self.prob_alert_threshold = prob_alert_threshold
        self.discord_webhook = discord_webhook or os.getenv('DISCORD_WEBHOOK_URL')
        
        # Initialize monitors
        self.fed_watch = FedWatchMonitor(alert_threshold=prob_alert_threshold)
        self.fed_officials = FedOfficialsMonitor()
        
        # State tracking
        self.last_prob_status: FedWatchStatus = None
        self.last_official_report: FedCommentReport = None
        self.seen_comments = set()  # Track seen comments to avoid duplicates
        
        # Stats
        self.scan_count = 0
        self.alert_count = 0
        
        logger.info("=" * 70)
        logger.info("ğŸ¦ FED EXPLOITATION MONITOR STARTED")
        logger.info("=" * 70)
        logger.info(f"   Check interval: {check_interval} seconds ({check_interval/60:.1f} min)")
        logger.info(f"   Probability alert threshold: {prob_alert_threshold}% change")
        logger.info(f"   Discord: {'âœ… Configured' if self.discord_webhook else 'âŒ Not configured'}")
        logger.info(f"   Tracking: CME FedWatch + 14 FOMC Members")
        logger.info("=" * 70)
    
    def send_discord_alert(self, embed: dict, content: str = None) -> bool:
        """Send alert to Discord."""
        if not self.discord_webhook:
            logger.warning("Discord webhook not configured")
            return False
        
        try:
            payload = {"embeds": [embed]}
            if content:
                payload["content"] = content
            
            response = requests.post(
                self.discord_webhook,
                json=payload,
                timeout=10
            )
            
            if response.status_code in [200, 204]:
                logger.info("âœ… Discord alert sent")
                return True
            else:
                logger.warning(f"Discord alert failed: {response.status_code}")
                return False
                
        except Exception as e:
            logger.error(f"Discord error: {e}")
            return False
    
    def _create_probability_alert(self, status: FedWatchStatus, changes: list) -> dict:
        """Create Discord embed for probability change."""
        max_change = max(abs(c[1]) for c in changes)
        if max_change >= 15:
            color = 15548997  # Red
            title = "ğŸš¨ MAJOR FED WATCH SHIFT"
        elif max_change >= 10:
            color = 16776960  # Yellow
            title = "âš ï¸ SIGNIFICANT FED WATCH CHANGE"
        else:
            color = 3447003  # Blue
            title = "ğŸ“Š Fed Watch Update"
        
        change_lines = []
        for prob_type, change, new_value in changes:
            emoji = "ğŸ“ˆ" if change > 0 else "ğŸ“‰"
            change_lines.append(f"{emoji} **{prob_type}**: {new_value:.1f}% ({change:+.1f}%)")
        
        implications = self.fed_watch.get_market_implications(status)
        
        embed = {
            "title": title,
            "color": color,
            "fields": [
                {"name": "ğŸ“Š Changes", "value": "\n".join(change_lines), "inline": False},
                {"name": "Current", "value": f"Cut: {status.prob_cut:.1f}% | Hold: {status.prob_hold:.1f}% | Hike: {status.prob_hike:.1f}%", "inline": False},
                {"name": "ğŸ¯ Most Likely", "value": f"{status.most_likely_outcome} ({status.most_likely_probability:.1f}%)", "inline": True},
                {"name": "ğŸ“… Next FOMC", "value": f"{status.next_meeting.date.strftime('%b %d')} ({status.next_meeting.days_until}d)" if status.next_meeting else "N/A", "inline": True},
                {"name": "ğŸ’¡ Implication", "value": implications['summary'][:200], "inline": False},
            ],
            "footer": {"text": "Fed Watch Monitor | Be First!"},
            "timestamp": datetime.utcnow().isoformat()
        }
        
        return embed
    
    def _create_official_alert(self, comment) -> dict:
        """Create Discord embed for Fed official comment."""
        sent_color = {
            "HAWKISH": 15548997,  # Red
            "DOVISH": 3066993,    # Green
            "NEUTRAL": 3447003   # Blue
        }.get(comment.sentiment, 3447003)
        
        sent_emoji = {"HAWKISH": "ğŸ¦…", "DOVISH": "ğŸ•Šï¸", "NEUTRAL": "â¡ï¸"}.get(comment.sentiment, "â“")
        impact_emoji = {"BULLISH": "ğŸŸ¢", "BEARISH": "ğŸ”´", "NEUTRAL": "ğŸŸ¡"}.get(comment.market_impact, "â“")
        
        # Truncate content
        content = comment.content[:300] + "..." if len(comment.content) > 300 else comment.content
        
        embed = {
            "title": f"ğŸ¤ {comment.official.name} ({comment.official.position.value})",
            "color": sent_color,
            "description": f'"{content}"',
            "fields": [
                {"name": f"{sent_emoji} Sentiment", "value": comment.sentiment, "inline": True},
                {"name": f"{impact_emoji} Market Impact", "value": comment.market_impact, "inline": True},
                {"name": "ğŸ’¯ Confidence", "value": f"{comment.confidence*100:.0f}%", "inline": True},
            ],
            "footer": {"text": "Fed Officials Monitor | Every Word Matters!"},
            "timestamp": datetime.utcnow().isoformat()
        }
        
        if comment.hawkish_keywords:
            embed["fields"].append({
                "name": "ğŸ¦… Hawkish Keywords",
                "value": ", ".join(comment.hawkish_keywords[:5]),
                "inline": False
            })
        
        if comment.dovish_keywords:
            embed["fields"].append({
                "name": "ğŸ•Šï¸ Dovish Keywords",
                "value": ", ".join(comment.dovish_keywords[:5]),
                "inline": False
            })
        
        # Trading implication
        if comment.market_impact == "BULLISH":
            embed["fields"].append({
                "name": "ğŸ’° Trade Idea",
                "value": "Dovish = LONG QQQ, TLT | SHORT XLF",
                "inline": False
            })
        elif comment.market_impact == "BEARISH":
            embed["fields"].append({
                "name": "ğŸ’° Trade Idea",
                "value": "Hawkish = LONG XLF, SHY | REDUCE QQQ",
                "inline": False
            })
        
        return embed
    
    def scan_once(self):
        """Run a single scan and alert on findings."""
        self.scan_count += 1
        logger.info(f"ğŸ“¡ Scan #{self.scan_count} starting...")
        
        # 1. Check FedWatch probabilities
        logger.info("   ğŸ¦ Checking CME FedWatch...")
        current_prob = self.fed_watch.get_current_status(force_refresh=True)
        
        if self.last_prob_status:
            # Check for significant changes
            changes = []
            
            cut_change = current_prob.prob_cut - self.last_prob_status.prob_cut
            hold_change = current_prob.prob_hold - self.last_prob_status.prob_hold
            hike_change = current_prob.prob_hike - self.last_prob_status.prob_hike
            
            if abs(cut_change) >= self.prob_alert_threshold:
                changes.append(('CUT', cut_change, current_prob.prob_cut))
            if abs(hold_change) >= self.prob_alert_threshold:
                changes.append(('HOLD', hold_change, current_prob.prob_hold))
            if abs(hike_change) >= self.prob_alert_threshold:
                changes.append(('HIKE', hike_change, current_prob.prob_hike))
            
            if changes:
                logger.info("   ğŸš¨ PROBABILITY CHANGE DETECTED!")
                for prob_type, change, new_value in changes:
                    logger.info(f"      {prob_type}: {new_value:.1f}% ({change:+.1f}%)")
                
                # Send Discord alert
                embed = self._create_probability_alert(current_prob, changes)
                self.send_discord_alert(embed, content="@everyone ğŸ¦ Fed rate probability change!")
                self.alert_count += 1
        
        self.last_prob_status = current_prob
        logger.info(f"      Cut: {current_prob.prob_cut:.1f}% | Hold: {current_prob.prob_hold:.1f}% | Hike: {current_prob.prob_hike:.1f}%")
        
        # 2. Check Fed official comments
        logger.info("   ğŸ¤ Checking Fed official comments...")
        report = self.fed_officials.get_report()
        
        new_comments = []
        for comment in report.comments:
            # Create unique ID for comment
            comment_id = f"{comment.official.name}:{comment.content[:50]}"
            
            if comment_id not in self.seen_comments:
                self.seen_comments.add(comment_id)
                new_comments.append(comment)
        
        if new_comments:
            logger.info(f"   ğŸ“¢ {len(new_comments)} NEW Fed comments detected!")
            
            for comment in new_comments:
                logger.info(f"      â€¢ {comment.official.name}: {comment.sentiment}")
                
                # Send Discord alert for significant comments
                if comment.confidence >= 0.4 or comment.official.name == "Jerome Powell":
                    embed = self._create_official_alert(comment)
                    self.send_discord_alert(embed)
                    self.alert_count += 1
        else:
            logger.info(f"      No new comments (tracking {len(self.seen_comments)} seen)")
        
        self.last_official_report = report
        
        logger.info(f"   âœ… Scan complete | Alerts sent: {self.alert_count}")
    
    def run(self):
        """Run continuous monitoring."""
        logger.info("ğŸš€ Starting continuous Fed monitoring...")
        
        # Startup alert
        if self.discord_webhook:
            embed = {
                "title": "ğŸ¦ Fed Exploitation Monitor - ONLINE",
                "color": 3066993,
                "description": "Monitoring CME FedWatch probabilities + FOMC member comments",
                "fields": [
                    {"name": "â±ï¸ Check Interval", "value": f"{self.check_interval/60:.0f} min", "inline": True},
                    {"name": "ğŸ“Š Alert Threshold", "value": f"{self.prob_alert_threshold}%", "inline": True},
                    {"name": "ğŸ‘¥ FOMC Members", "value": "14 tracked", "inline": True},
                ],
                "footer": {"text": "Be first on every Fed move!"},
                "timestamp": datetime.utcnow().isoformat()
            }
            self.send_discord_alert(embed)
        
        # Initial scan
        self.scan_once()
        
        while True:
            try:
                logger.info(f"â³ Next scan in {self.check_interval} seconds...")
                time.sleep(self.check_interval)
                self.scan_once()
                
            except KeyboardInterrupt:
                logger.info("\nğŸ›‘ Monitor stopped by user")
                break
            except Exception as e:
                logger.error(f"âŒ Error: {e}")
                time.sleep(60)
    
    def print_dashboard(self):
        """Print a comprehensive Fed dashboard."""
        print("\n" + "=" * 80)
        print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
        print("â•‘              ğŸ¦ FED EXPLOITATION DASHBOARD - COMPLETE INTEL                    â•‘")
        print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
        print(f"  Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("=" * 80)
        
        # FedWatch
        self.fed_watch.print_fed_dashboard()
        
        # Officials
        report = self.fed_officials.get_report()
        self.fed_officials.print_fed_officials_report(report)


def main():
    """Main entry point."""
    import argparse
    
    parser = argparse.ArgumentParser(description="Fed Exploitation Monitor")
    parser.add_argument("--interval", type=int, default=300, help="Check interval in seconds")
    parser.add_argument("--threshold", type=float, default=5.0, help="Probability alert threshold")
    parser.add_argument("--once", action="store_true", help="Single scan only")
    parser.add_argument("--dashboard", action="store_true", help="Print dashboard and exit")
    
    args = parser.parse_args()
    
    monitor = FedExploitationMonitor(
        check_interval=args.interval,
        prob_alert_threshold=args.threshold
    )
    
    if args.dashboard:
        monitor.print_dashboard()
    elif args.once:
        monitor.scan_once()
    else:
        monitor.run()


if __name__ == "__main__":
    main()


